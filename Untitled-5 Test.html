<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SU Student Bus Management System</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Favicon Links -->
    <link rel="icon" href="sufavicon.png" type="image/png">
    <link rel="icon" href="sufavicon.png" sizes="16x16" type="image/png">
    <link rel="icon" href="sufavicon.png" sizes="32x32" type="image/png">
    <link rel="apple-touch-icon" href="sufavicon.png">
    <style>
        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .hidden {
            display: none !important;
        }

        /* Header Styles */
        header {
            background-color: var(--primary);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-image {
            height: 50px;
            width: auto;
            display: flex;
            align-items: center;
        }

        .logo-image img {
            height: 100%;
            width: auto;
            object-fit: contain;
        }

        .logo h1 {
            font-size: 1.5rem;
        }

        .logo-icon {
            font-size: 1.8rem;
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 20px;
        }

        nav a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        nav a:hover,
        nav a.active {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Login Form Styles */
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-container h2 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--secondary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s, transform 0.2s;
        }

        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-warning {
            background-color: var(--warning);
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .portal-selection {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }

        .portal-card {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            width: 300px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .portal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .portal-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .student-portal {
            border-top: 4px solid #3498db;
        }

        .driver-portal {
            border-top: 4px solid #2ecc71;
        }

        .admin-portal {
            border-top: 4px solid #e74c3c;
        }

        /* Dashboard Styles */
        .dashboard {
            padding: 20px 0;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .welcome-message {
            font-size: 1.2rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .map-container {
            height: 300px;
            background-color: #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .bus-list {
            list-style: none;
        }

        .bus-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s;
        }

        .bus-item:hover {
            background-color: #f8f9fa;
        }

        .bus-info h4 {
            margin-bottom: 5px;
        }

        .bus-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-ontime {
            background-color: #d4edda;
            color: #155724;
        }

        .status-delayed {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-arrived {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .table tr:hover {
            background-color: #f5f5f5;
        }

        .notification {
            padding: 15px;
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            margin-bottom: 15px;
            border-radius: 4px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification.error {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }

        .notification.success {
            background-color: #d4edda;
            border-left-color: #28a745;
        }

        /* Profile Styles */
        .profile-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--secondary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            margin-right: 20px;
        }

        .profile-info h2 {
            margin-bottom: 5px;
        }

        .profile-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .detail-group {
            margin-bottom: 15px;
        }

        .detail-label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #666;
        }

        .detail-value {
            font-size: 1.1rem;
        }

        /* Seat Selection */
        .seat-map {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .seat {
            padding: 15px;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .seat-available {
            background-color: #d4edda;
            color: #155724;
        }

        .seat-booked {
            background-color: #f8d7da;
            color: #721c24;
            cursor: not-allowed;
        }

        .seat-selected {
            background-color: #fff3cd;
            color: #856404;
        }

        .seat-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 2px;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--secondary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }

            .portal-selection {
                flex-direction: column;
                align-items: center;
            }

            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .card-grid {
                grid-template-columns: 1fr;
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
            }

            .profile-avatar {
                margin-right: 0;
                margin-bottom: 15px;
            }

            .seat-map {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Additional styles for stop management */
        .stops-container {
            margin-top: 15px;
        }

        .stop-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .stop-item input {
            flex: 1;
        }

        .remove-stop {
            background-color: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }

        .add-stop {
            background-color: var(--success);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Additional styles for new features */
        .notification-badge {
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        .route-direction {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .route-direction-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .route-direction-btn.active {
            background-color: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        .stop-selector {
            margin-bottom: 15px;
        }

        .booking-time-info {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .booking-time-info.warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .booking-time-info.error {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .driver-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .driver-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--secondary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .bus-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detail-item {
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .detail-value {
            font-weight: 500;
        }

        /* Enhanced Seat Map Styles - New Layout */
        .seat-map-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }

        .bus-layout {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #dee2e6;
        }

        /* First Row - A1, A2 on left side */
        .front-row-a {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        /* Second Row - B1, B2 on left, DRIVER on right */
        .front-row-b {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        /* Door section on left side */
        .door-section {
            grid-column: 1 / 3;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            margin: 5px 0;
            font-weight: bold;
            border: 1px solid #ced4da;
        }

        /* Main seating area with 5 columns */
        .seats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            gap: 8px;
        }

        .seat-row {
            display: contents;
        }

        .seat {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 45px;
            text-align: center;
            border: 1px solid transparent;
        }

        .seat-available {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .seat-booked {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
            cursor: not-allowed;
        }

        .seat-selected {
            background-color: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
            box-shadow: 0 0 0 2px #ffc107;
        }

        /* Special styling for empty middle column */
        .empty-space {
            background-color: transparent;
            border: none;
            cursor: default;
        }

        /* Special styling for K3 seat in the middle */
        .k3-seat {
            grid-column: 3;
        }

        .seat-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 2px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .seats-grid {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 5px;
            }

            .front-row-a,
            .front-row-b {
                grid-template-columns: 1fr 1fr 1fr;
            }

            .seat {
                padding: 8px 4px;
                font-size: 0.8rem;
                min-height: 40px;
            }

            .k3-seat {
                grid-column: 2;
            }
        }

        .stop-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .stop-item input {
            flex: 1;
        }

        .remove-stop {
            background-color: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }

        .add-stop {
            background-color: var(--success);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Additional styles for updated student sections */
        .estimated-arrival-info {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .estimated-arrival-info p {
            margin-bottom: 5px;
        }

        .seat-booking-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .direction-booking {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }

        .direction-booking h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .mt-10 {
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .seat-booking-info {
                grid-template-columns: 1fr;
            }
        }

        /* Admin Dashboard Specific Styles */
        .bus-status-overview {
            margin-bottom: 20px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .status-count {
            font-weight: bold;
            color: var(--dark);
        }

        .detailed-bus-list {
            margin-top: 20px;
        }

        .system-stats-overview {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        /* Enhanced notification styles */
        .notification.warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }

        .notification.error {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }

        .notification.success {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }

        .search-container {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .search-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .search-btn {
            padding: 10px 20px;
            background-color: var(--secondary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .passenger-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .passenger-direction {
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            text-align: center;
        }

        .passenger-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        /* Enhanced Notification Styles */
        .notification-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .notification-item.emergency {
            border-left-color: #e74c3c;
            background-color: #fdf2f2;
        }

        .notification-item.warning {
            border-left-color: #f39c12;
            background-color: #fef9f3;
        }

        .notification-item.success {
            border-left-color: #2ecc71;
            background-color: #f2fdf5;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .notification-title {
            font-weight: bold;
            font-size: 1.1rem;
            color: #2c3e50;
        }

        .notification-type {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .notification-message {
            color: #555;
            margin-bottom: 8px;
        }

        .notification-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #777;
        }

        /* Driver Stop Passenger Styles */
        .passenger-count-info {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .passenger-count-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .passenger-stop-item {
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            border-left: 3px solid #3498db;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .stop-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .passenger-count {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .direction-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 3px;
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Enhanced Notification Styles */
        .notification-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .notification-item.emergency {
            border-left-color: #e74c3c;
            background-color: #fdf2f2;
        }

        .notification-item.warning {
            border-left-color: #f39c12;
            background-color: #fef9f3;
        }

        .notification-item.success {
            border-left-color: #2ecc71;
            background-color: #f2fdf5;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .notification-title {
            font-weight: bold;
            font-size: 1.1rem;
            color: #2c3e50;
        }

        .notification-type {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            background-color: #ecf0f1;
            color: #2c3e50;
        }

        .notification-message {
            color: #555;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .notification-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #777;
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .spinner-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .empty-state,
        .error-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #666;
        }

        .empty-state-icon,
        .error-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .small-text {
            font-size: 0.8rem;
            color: #888;
            margin-top: 0.5rem;
        }

        .notification-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: white;
        }

        .notification-item.emergency {
            border-left: 4px solid #e74c3c;
            background: #ffeaea;
        }

        .notification-item.warning {
            border-left: 4px solid #f39c12;
            background: #fff4e6;
        }

        .notification-item.success {
            border-left: 4px solid #27ae60;
            background: #eafaf1;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .notification-title {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .notification-type {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            background: #f8f9fa;
        }

        .notification-message {
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .notification-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #666;
        }

        .report-form {
            padding: 20px;
        }

        .report-entry {
            transition: background-color 0.3s;
        }

        .report-entry:hover {
            background-color: #f8f9fa;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #464545;
            font-size: 0.9rem;
            margin-top: auto;
            opacity: 10;
            animation: fadeIn 1s ease 2.4s forwards;
        }
    </style>
</head>

<body>
    <!-- Main Portal Selection -->
    <div id="main-portal" class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <div class="logo-image">
                        <img src="Sonargaon University Logo.png" alt="Sonargaon University Logo">
                    </div>
                    <h1>Sonargaon University Bus Management</h1>
                </div>
            </div>
        </header>

        <div class="portal-selection">
            <div class="portal-card student-portal" onclick="showLogin('student')">
                <div class="portal-icon">üßç‚Äç‚ôÇÔ∏è</div>
                <h2>Student Portal</h2>
                <p>Track buses, book seats, and view schedules</p>
            </div>

            <div class="portal-card driver-portal" onclick="showLogin('driver')">
                <div class="portal-icon">üöó</div>
                <h2>Driver Portal</h2>
                <p>Update route status and location</p>
            </div>

            <div class="portal-card admin-portal" onclick="showLogin('admin')">
                <div class="portal-icon">üßë‚Äçüíº</div>
                <h2>Admin Portal</h2>
                <p>Manage buses, drivers, and students</p>
            </div>
        </div>
    </div>

    <!-- Student Portal -->
    <div id="student-portal" class="hidden">
        <header>
            <div class="header-content">
                <div class="logo">
                    <div class="logo-image">
                        <img src="Sonargaon University Logo.png" alt="Sonargaon University Logo">
                    </div>
                    <h1>Student Portal</h1>
                </div>
                <nav>
                    <ul>
                        <li><a href="#" class="active" onclick="showStudentSection('dashboard')">Dashboard</a></li>
                        <li><a href="#" onclick="showStudentSection('tracking')">Bus Tracking</a></li>
                        <li><a href="#" onclick="showStudentSection('booking')">Seat Booking</a></li>
                        <li><a href="#" onclick="showStudentSection('profile')">Profile</a></li>
                        <li>
                            <a href="#" onclick="showStudentSection('notifications')">
                                Notifications
                                <span id="notification-badge" class="notification-badge hidden">0</span>
                            </a>
                        </li>
                        <li><a href="#" onclick="logout()">Logout</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <div class="container dashboard">
            <!-- Student Dashboard -->
            <div id="student-dashboard" class="student-section">
                <div class="dashboard-header">
                    <div class="welcome-message">
                        <h2 id="student-welcome">Welcome!</h2>
                        <p>Here's your bus information for today</p>
                    </div>
                    <div class="user-info">
                        <div class="user-avatar" id="student-avatar">U</div>
                        <span id="student-id-display">ID: Loading...</span>
                    </div>
                </div>

                <div id="student-notifications"></div>

                <div class="card-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">My Bus Info</h3>
                        </div>
                        <div id="student-bus-info" class="bus-info">
                            <div class="spinner"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Seat Status</h3>
                        </div>
                        <div id="student-seat-info" class="seat-info">
                            <div class="spinner"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Quick Actions</h3>
                        </div>
                        <div class="quick-actions">
                            <button class="btn btn-block" onclick="showStudentSection('tracking')">Track My Bus</button>
                            <button class="btn btn-block mt-20" onclick="showStudentSection('booking')">Book a
                                Seat</button>
                            <button class="btn btn-block mt-20" onclick="showStudentSection('profile')">Update
                                Profile</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Available Buses</h3>
                    </div>
                    <ul id="student-bus-list" class="bus-list">
                        <div class="spinner"></div>
                    </ul>
                </div>
            </div>

            <!-- Student Bus Tracking -->
            <div id="student-tracking" class="student-section hidden">
                <div class="dashboard-header">
                    <h2>Live Bus Tracking</h2>
                    <button class="btn" onclick="showStudentSection('dashboard')">Back to Dashboard</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title" id="tracking-route-title">Route Information</h3>
                        <div id="tracking-status"></div>
                    </div>
                    <div class="map-container">
                        <div id="student-map" style="height: 100%;"></div>
                    </div>
                    <div id="tracking-bus-details" class="bus-details">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Student Seat Booking Section -->
            <div id="student-booking" class="student-section hidden">
                <div class="dashboard-header">
                    <h2>Seat Booking</h2>
                    <button class="btn" onclick="showStudentSection('dashboard')">Back to Dashboard</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Select Your Route</h3>
                    </div>
                    <div class="form-group">
                        <label for="route-select">Choose Route:</label>
                        <select id="route-select" onchange="loadSeatsForRoute()">
                            <option value="">-- Select Route --</option>
                        </select>
                    </div>

                    <div class="route-direction">
                        <div class="route-direction-btn active" id="direction-to-campus"
                            onclick="selectDirection('to-campus')">
                            Stops to SU Campus
                        </div>
                        <div class="route-direction-btn" id="direction-from-campus"
                            onclick="selectDirection('from-campus')">
                            SU Campus to Stops
                        </div>
                    </div>

                    <div class="stop-selector">
                        <label for="stop-select">Select Your Stop:</label>
                        <select id="stop-select" onchange="updateEstimatedArrival()">
                            <option value="">-- Select Stop --</option>
                        </select>
                    </div>

                    <div id="booking-time-info" class="booking-time-info hidden">
                        <!-- Booking time information will be displayed here -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Available Seats</h3>
                    </div>
                    <div class="seat-map-container" id="seat-map-container">
                        <p>Please select a route first</p>
                    </div>
                    <div class="seat-legend">
                        <div class="legend-item">
                            <div class="legend-color seat-available"></div>
                            <span>Available</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color seat-booked"></div>
                            <span>Booked</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color seat-selected"></div>
                            <span>Selected</span>
                        </div>
                    </div>
                    <div class="text-center mt-20">
                        <button class="btn btn-success" id="confirm-booking-btn" onclick="confirmBooking()"
                            disabled>Confirm Booking</button>
                    </div>
                </div>
            </div>

            <!-- Student Profile -->
            <div id="student-profile" class="student-section hidden">
                <div class="dashboard-header">
                    <h2>My Profile</h2>
                    <button class="btn" onclick="showStudentSection('dashboard')">Back to Dashboard</button>
                </div>

                <div class="profile-container">
                    <div class="profile-header">
                        <div class="profile-avatar" id="profile-avatar">U</div>
                        <div class="profile-info">
                            <h2 id="profile-name">Loading...</h2>
                            <p id="profile-id">Student ID: Loading...</p>
                            <p id="profile-department">Department: Loading...</p>
                        </div>
                    </div>

                    <form id="profile-form">
                        <div class="profile-details">
                            <div>
                                <div class="form-group">
                                    <label for="profile-fullname">Full Name</label>
                                    <input type="text" id="profile-fullname" required>
                                </div>
                                <div class="form-group">
                                    <label for="profile-studentid">Student ID</label>
                                    <input type="text" id="profile-studentid" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="profile-email">Email</label>
                                    <input type="email" id="profile-email" required>
                                </div>
                            </div>

                            <div>
                                <div class="form-group">
                                    <label for="profile-department-input">Department</label>
                                    <input type="text" id="profile-department-input" required>
                                </div>
                                <div class="form-group">
                                    <label for="profile-batch">Batch</label>
                                    <input type="text" id="profile-batch" required>
                                </div>
                                <div class="form-group">
                                    <label for="profile-phone">Phone</label>
                                    <input type="tel" id="profile-phone" required>
                                </div>
                            </div>

                            <div>
                                <div class="form-group">
                                    <label for="profile-route">Assigned Route</label>
                                    <select id="profile-route" required>
                                        <option value="">-- Select Route --</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="profile-bus">Bus Details</label>
                                    <input type="text" id="profile-bus" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="profile-driver">Driver</label>
                                    <input type="text" id="profile-driver" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="profile-driver-phone">Driver Phone</label>
                                    <input type="text" id="profile-driver-phone" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-20">
                            <button type="submit" class="btn">Update Profile</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Student Notifications -->
            <div id="student-notifications-page" class="student-section hidden">
                <div class="dashboard-header">
                    <h2>Notifications</h2>
                    <button class="btn" onclick="showStudentSection('dashboard')">Back to Dashboard</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">All Notifications</h3>
                        <button class="btn" onclick="markAllNotificationsAsRead()">Mark All as Read</button>
                    </div>
                    <div id="student-all-notifications" class="notification-list">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Driver Portal -->
    <div id="driver-portal" class="hidden">
        <header>
            <div class="header-content">
                <div class="logo">
                    <div class="logo-image">
                        <img src="Sonargaon University Logo.png" alt="Sonargaon University Logo">
                    </div>
                    <h1>Driver Portal</h1>
                </div>
                <nav>
                    <ul>
                        <li><a href="#" class="active" onclick="showDriverSection('dashboard')">Dashboard</a></li>
                        <li><a href="#" onclick="showDriverSection('location')">Location Update</a></li>
                        <li><a href="#" onclick="showDriverSection('notifications')">Notifications</a></li>
                        <li><a href="#" onclick="logout()">Logout</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <div class="container dashboard">
            <!-- Driver Dashboard -->
            <div id="driver-dashboard" class="driver-section">
                <div class="dashboard-header">
                    <div class="welcome-message">
                        <h2 id="driver-welcome">Welcome!</h2>
                        <p id="driver-route-info">Route Information</p>
                    </div>
                    <div class="user-info">
                        <div class="user-avatar" id="driver-avatar">D</div>
                        <span id="driver-id-display">Driver ID: Loading...</span>
                    </div>
                </div>

                <div class="card-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Today's Schedule</h3>
                        </div>
                        <div id="driver-schedule" class="schedule-info">
                            <div class="spinner"></div>
                        </div>

                        <!-- NEW: Passenger Count by Stop -->
                        <div id="passenger-count-container" class="passenger-count-info hidden">
                            <h4>Passenger Count by Stop</h4>
                            <div id="passenger-count-grid" class="passenger-count-grid">
                                <!-- Passenger counts will be populated here -->
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Quick Actions</h3>
                        </div>
                        <div class="quick-actions">
                            <button class="btn btn-block" onclick="updateBusStatus('On the way')">Start Trip</button>
                            <button class="btn btn-success btn-block mt-20" onclick="updateBusStatus('Arrived')">Mark
                                Arrived</button>
                            <button class="btn btn-warning btn-block mt-20"
                                onclick="showDriverSection('location')">Update Location</button>
                            <button class="btn btn-block mt-20" onclick="showDriverSection('notifications')">Send
                                Notification</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Route Information</h3>
                        </div>
                        <div id="driver-route-details" class="route-info">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Live Location</h3>
                    </div>
                    <div class="map-container">
                        <div id="driver-map" style="height: 100%;"></div>
                    </div>
                </div>
            </div>

            <!-- Driver Location Update -->
            <div id="driver-location" class="driver-section hidden">
                <div class="dashboard-header">
                    <h2>Location Update</h2>
                    <button class="btn" onclick="showDriverSection('dashboard')">Back to Dashboard</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Update Your Location</h3>
                    </div>
                    <div class="location-update">
                        <p>Your current location is automatically shared with the system. You can also manually update
                            your status.</p>

                        <div class="form-group mt-20">
                            <label for="bus-status">Bus Status:</label>
                            <select id="bus-status">
                                <option value="On the way">On the way</option>
                                <option value="Delayed">Delayed</option>
                                <option value="Arrived">Arrived</option>
                                <option value="Breakdown">Breakdown</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="delay-reason">Delay Reason (if applicable):</label>
                            <input type="text" id="delay-reason" placeholder="e.g., Traffic jam, accident, etc.">
                        </div>

                        <div class="form-group">
                            <label for="next-stop">Next Stop:</label>
                            <select id="next-stop"></select>
                        </div>

                        <div class="form-group">
                            <label for="eta">Estimated Time to Next Stop (minutes):</label>
                            <input type="number" id="eta" min="0" value="0">
                        </div>

                        <button class="btn btn-block" onclick="updateLocation()">Update Location & Status</button>
                    </div>
                </div>
            </div>

            <!-- Driver Notifications -->
            <div id="driver-notifications" class="driver-section hidden">
                <div class="dashboard-header">
                    <h2>Send Notifications</h2>
                    <button class="btn" onclick="showDriverSection('dashboard')">Back to Dashboard</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Create Notification</h3>
                    </div>
                    <div class="notification-form">
                        <div class="form-group">
                            <label for="notification-type">Notification Type:</label>
                            <select id="notification-type">
                                <option value="Delay">Delay Alert</option>
                                <option value="Route Change">Route Change</option>
                                <option value="General">General Information</option>
                                <option value="Emergency">Emergency</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="notification-title">Title:</label>
                            <input type="text" id="notification-title" placeholder="Enter notification title">
                        </div>

                        <div class="form-group">
                            <label for="notification-message">Message:</label>
                            <textarea id="notification-message" rows="4"
                                placeholder="Enter notification message"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="notification-audience">Send To:</label>
                            <select id="notification-audience">
                                <option value="all">All Students</option>
                                <option value="route">My Route Students Only</option>
                                <option value="admin">Admin Only</option>
                            </select>
                        </div>

                        <button class="btn btn-block" onclick="sendNotification()">Send Notification</button>
                    </div>
                </div>

                <div class="card mt-20">
                    <div class="card-header">
                        <h3 class="card-title">Recent Notifications</h3>
                        <button class="btn" onclick="loadDriverNotifications()">Refresh</button>
                    </div>
                    <div id="driver-notification-list" class="notification-list">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Portal -->
    <div id="admin-portal" class="hidden">
        <header>
            <div class="header-content">
                <div class="logo">
                    <div class="logo-image">
                        <img src="Sonargaon University Logo.png" alt="Sonargaon University Logo">
                    </div>
                    <h1>Admin Portal</h1>
                </div>
                <nav>
                    <ul>
                        <li><a href="#" class="active" onclick="showAdminSection('dashboard')">Dashboard</a></li>
                        <li><a href="#" onclick="showAdminSection('reports')">Reports</a></li>
                        <li><a href="#" onclick="showAdminSection('buses')">Bus Management</a></li>
                        <li><a href="#" onclick="showAdminSection('drivers')">Driver Management</a></li>
                        <li><a href="#" onclick="showAdminSection('students')">Student Management</a></li>
                        <li><a href="#" onclick="showAdminSection('tracking')">Live Tracking</a></li>
                        <li><a href="#" onclick="showAdminSection('notifications')">Notifications</a></li>
                        <li><a href="#" onclick="logout()">Logout</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <div class="container dashboard">
            <!-- Admin Dashboard -->
            <div id="admin-dashboard" class="admin-section">
                <div class="dashboard-header">
                    <div class="welcome-message">
                        <h2>Admin Dashboard</h2>
                        <p>Overview of the SU Bus Management System</p>
                    </div>
                    <div class="user-info">
                        <div class="user-avatar">A</div>
                        <span>Administrator</span>
                    </div>
                </div>

                <div class="card-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">System Overview</h3>
                        </div>
                        <div id="admin-system-stats" class="system-stats">
                            <div class="spinner"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Quick Actions</h3>
                        </div>
                        <div class="quick-actions">
                            <button class="btn btn-block" onclick="showAdminSection('buses')">Manage Buses</button>
                            <button class="btn btn-block mt-20" onclick="showAdminSection('drivers')">Manage
                                Drivers</button>
                            <button class="btn btn-block mt-20" onclick="showAdminSection('students')">Manage
                                Students</button>
                            <button class="btn btn-block mt-20" onclick="showAdminSection('notifications')">Send
                                Notification</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">System Alerts</h3>
                        </div>
                        <div id="admin-alerts" class="alerts">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Bus Status Overview</h3>
                    </div>
                    <div id="admin-bus-status">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Admin Reports Generated -->
            <div id="admin-reports" class="admin-section hidden">
                <div class="dashboard-header">
                    <h2>Generate Passenger Reports</h2>
                    <button class="btn" onclick="showAdminSection('dashboard')">Back to Dashboard</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Select Report Parameters</h3>
                    </div>
                    <div class="report-form">
                        <div class="form-group">
                            <label for="report-date">Select Date:</label>
                            <input type="date" id="report-date" required>
                        </div>
                        <div class="form-group">
                            <label for="report-route">Select Route:</label>
                            <select id="report-route" required>
                                <option value="">-- Select Route --</option>
                            </select>
                        </div>
                        <button class="btn btn-success" onclick="generatePassengerReport()">Generate PDF Report</button>
                    </div>
                </div>

                <div class="card mt-20">
                    <div class="card-header">
                        <h3 class="card-title">Recent Reports</h3>
                    </div>
                    <div id="recent-reports-list">
                        <p>No reports generated yet</p>
                    </div>
                </div>
            </div>

            <!-- Admin Bus Management -->
            <div id="admin-buses" class="admin-section hidden">
                <div class="dashboard-header">
                    <h2>Bus Management</h2>
                    <button class="btn" onclick="showAdminSection('dashboard')">Back to Dashboard</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">All Buses</h3>
                        <button class="btn btn-success" onclick="showAddBusForm()">Add New Bus</button>
                    </div>

                    <!-- Search Bar for Buses -->
                    <div class="search-container">
                        <input type="text" id="bus-search" class="search-input"
                            placeholder="Search buses by route, number, or status..." onkeyup="searchBuses()">
                        <button class="search-btn" onclick="searchBuses()">Search</button>
                    </div>

                    <div id="admin-bus-table">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- Add/Edit Bus Form - ENHANCED VERSION -->
                <div id="bus-form-container" class="card mt-20 hidden">
                    <div class="card-header">
                        <h3 class="card-title" id="bus-form-title">Add New Bus</h3>
                    </div>
                    <form id="bus-form">
                        <input type="hidden" id="bus-id">
                        <div class="form-group">
                            <label for="bus-route-no">Route No *</label>
                            <input type="text" id="bus-route-no" required>
                        </div>
                        <div class="form-group">
                            <label for="bus-route-name">Route Name *</label>
                            <input type="text" id="bus-route-name" required>
                        </div>
                        <div class="form-group">
                            <label for="bus-number">Bus Number *</label>
                            <input type="text" id="bus-number" required>
                        </div>
                        <div class="form-group">
                            <label for="bus-driver">Driver *</label>
                            <select id="bus-driver" required>
                                <option value="">-- Select Driver --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="bus-capacity">Capacity *</label>
                            <input type="number" id="bus-capacity" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="bus-status">Status *</label>
                            <select id="bus-status" required>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="On the way">On the way</option>
                                <option value="Delayed">Delayed</option>
                                <option value="Arrived">Arrived</option>
                                <option value="Breakdown">Breakdown</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="bus-departure">Departure Time *</label>
                            <input type="time" id="bus-departure" required>
                        </div>
                        <div class="form-group">
                            <label for="bus-departure-from-campus">Departure Time From Campus *</label>
                            <input type="time" id="bus-departure-from-campus" required>
                        </div>
                        <div class="form-group">
                            <label for="bus-distance">Distance (km) *</label>
                            <input type="number" id="bus-distance" min="0" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="bus-estimated-time">Estimated Time (minutes) *</label>
                            <input type="number" id="bus-estimated-time" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="bus-estimated-arrival">Estimated Arrival *</label>
                            <input type="time" id="bus-estimated-arrival" required>
                        </div>

                        <!-- Stops Management Section -->
                        <div class="form-group">
                            <label>Bus Stops *</label>
                            <div class="stops-container" id="stops-container">
                                <div class="stop-item">
                                    <input type="text" class="stop-name" placeholder="Stop name" required>
                                    <input type="time" class="stop-time" required>
                                    <button type="button" class="remove-stop" onclick="removeStop(this)">Remove</button>
                                </div>
                            </div>
                            <button type="button" class="add-stop" onclick="addStop()">Add Another Stop</button>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-success">Save Bus</button>
                            <button type="button" class="btn btn-danger" onclick="hideBusForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Admin Driver Management -->
            <div id="admin-drivers" class="admin-section hidden">
                <div class="dashboard-header">
                    <h2>Driver Management</h2>
                    <button class="btn" onclick="showAdminSection('dashboard')">Back to Dashboard</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">All Drivers</h3>
                        <button class="btn btn-success" onclick="showAddDriverForm()">Add New Driver</button>
                    </div>

                    <!-- Search Bar for Drivers -->
                    <div class="search-container">
                        <input type="text" id="driver-search" class="search-input"
                            placeholder="Search drivers by name, ID, or phone..." onkeyup="searchDrivers()">
                        <button class="search-btn" onclick="searchDrivers()">Search</button>
                    </div>

                    <div id="admin-driver-table">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- Add/Edit Driver Form -->
                <div id="driver-form-container" class="card mt-20 hidden">
                    <div class="card-header">
                        <h3 class="card-title" id="driver-form-title">Add New Driver</h3>
                    </div>
                    <form id="driver-form">
                        <input type="hidden" id="driver-id">
                        <div class="form-group">
                            <label for="driver-name">Name</label>
                            <input type="text" id="driver-name" required>
                        </div>
                        <div class="form-group">
                            <label for="driver-phone">Phone</label>
                            <input type="tel" id="driver-phone" required>
                        </div>
                        <div class="form-group">
                            <label for="driver-personal-phone">Personal Phone</label>
                            <input type="tel" id="driver-personal-phone" required>
                        </div>
                        <div class="form-group">
                            <label for="driver-email">Email</label>
                            <input type="email" id="driver-email" required>
                        </div>
                        <div class="form-group">
                            <label for="driver-password">Password</label>
                            <input type="password" id="driver-password">
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-success">Save Driver</button>
                            <button type="button" class="btn btn-danger" onclick="hideDriverForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Admin Student Management -->
            <div id="admin-students" class="admin-section hidden">
                <div class="dashboard-header">
                    <h2>Student Management</h2>
                    <button class="btn" onclick="showAdminSection('dashboard')">Back to Dashboard</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">All Students</h3>
                        <button class="btn btn-success" onclick="showAddStudentForm()">Add New Student</button>
                    </div>

                    <!-- Search Bar for Students -->
                    <div class="search-container">
                        <input type="text" id="student-search" class="search-input"
                            placeholder="Search students by name, ID, or department..." onkeyup="searchStudents()">
                        <button class="search-btn" onclick="searchStudents()">Search</button>
                    </div>

                    <div id="admin-student-table">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- Add/Edit Student Form -->
                <div id="student-form-container" class="card mt-20 hidden">
                    <div class="card-header">
                        <h3 class="card-title" id="student-form-title">Add New Student</h3>
                    </div>
                    <form id="student-form">
                        <input type="hidden" id="student-form-id">
                        <div class="form-group">
                            <label for="student-form-name">Full Name</label>
                            <input type="text" id="student-form-name" required>
                        </div>
                        <div class="form-group">
                            <label for="student-form-id-input">Student ID</label>
                            <input type="text" id="student-form-id-input" required>
                        </div>
                        <div class="form-group">
                            <label for="student-form-email">Email</label>
                            <input type="email" id="student-form-email" required>
                        </div>
                        <div class="form-group">
                            <label for="student-form-department">Department</label>
                            <input type="text" id="student-form-department" required>
                        </div>
                        <div class="form-group">
                            <label for="student-form-batch">Batch</label>
                            <input type="text" id="student-form-batch" required>
                        </div>
                        <div class="form-group">
                            <label for="student-form-phone">Phone</label>
                            <input type="tel" id="student-form-phone" required>
                        </div>
                        <div class="form-group">
                            <label for="student-form-route">Assigned Route</label>
                            <select id="student-form-route" required>
                                <option value="">-- Select Route --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="student-form-password">Password</label>
                            <input type="password" id="student-form-password">
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-success">Save Student</button>
                            <button type="button" class="btn btn-danger" onclick="hideStudentForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Admin Live Tracking -->
            <div id="admin-tracking" class="admin-section hidden">
                <div class="dashboard-header">
                    <h2>Live Bus Tracking</h2>
                    <button class="btn" onclick="showAdminSection('dashboard')">Back to Dashboard</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">All Active Buses</h3>
                    </div>
                    <div class="map-container">
                        <div id="admin-map" style="height: 100%;"></div>
                    </div>
                </div>

                <div class="card mt-20">
                    <div class="card-header">
                        <h3 class="card-title">Bus Locations</h3>
                    </div>
                    <div id="admin-bus-locations">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Admin Notifications -->
            <div id="admin-notifications" class="admin-section hidden">
                <div class="dashboard-header">
                    <h2>Notification Management</h2>
                    <button class="btn" onclick="showAdminSection('dashboard')">Back to Dashboard</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Send Broadcast Notification</h3>
                    </div>
                    <div class="notification-form">
                        <div class="form-group">
                            <label for="admin-notification-type">Notification Type:</label>
                            <select id="admin-notification-type">
                                <option value="Delay">Delay Alert</option>
                                <option value="Route Change">Route Change</option>
                                <option value="General">General Information</option>
                                <option value="Emergency">Emergency</option>
                                <option value="Maintenance">Maintenance</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="admin-notification-title">Title:</label>
                            <input type="text" id="admin-notification-title" placeholder="Enter notification title">
                        </div>

                        <div class="form-group">
                            <label for="admin-notification-message">Message:</label>
                            <textarea id="admin-notification-message" rows="4"
                                placeholder="Enter notification message"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="admin-notification-audience">Send To:</label>
                            <select id="admin-notification-audience">
                                <option value="all">All Users</option>
                                <option value="students">Students Only</option>
                                <option value="drivers">Drivers Only</option>
                                <option value="specific-route">Specific Route</option>
                            </select>
                        </div>

                        <div class="form-group" id="route-select-container" style="display: none;">
                            <label for="admin-notification-route">Select Route:</label>
                            <select id="admin-notification-route">
                                <option value="">-- Select Route --</option>
                            </select>
                        </div>

                        <button class="btn btn-block" onclick="sendAdminNotification()">Send Notification</button>
                    </div>
                </div>

                <div class="card mt-20">
                    <div class="card-header">
                        <h3 class="card-title">Notification History</h3>
                    </div>
                    <div id="admin-notification-history">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Forms -->
    <div id="login-forms" class="hidden">
        <!-- Student Login - UPDATED -->
        <div id="student-login" class="login-container hidden">
            <h2>Student Login</h2>
            <div class="form-group">
                <label for="student-id">Student ID</label>
                <input type="text" id="student-id" placeholder="Enter your student ID">
            </div>
            <div class="form-group">
                <label for="student-password">Password</label>
                <input type="password" id="student-password" placeholder="Enter your password">
            </div>
            <button class="btn btn-block" onclick="login('student')">Login</button>
            <p class="text-center mt-20"><a href="#" onclick="showMainPortal()">Back to Portal Selection</a></p>
        </div>

        <!-- Driver Login -->
        <div id="driver-login" class="login-container hidden">
            <h2>Driver Login</h2>
            <div class="form-group">
                <label for="driver-email-input">Email</label>
                <input type="email" id="driver-email-input" placeholder="Enter your email" value="driver@su.edu">
            </div>
            <div class="form-group">
                <label for="driver-password-input">Password</label>
                <input type="password" id="driver-password-input" placeholder="Enter your password" value="driver123">
            </div>
            <button class="btn btn-block" onclick="login('driver')">Login</button>
            <p class="text-center mt-20"><a href="#" onclick="showMainPortal()">Back to Portal Selection</a></p>
        </div>

        <!-- Admin Login -->
        <div id="admin-login" class="login-container hidden">
            <h2>Admin Login</h2>
            <div class="form-group">
                <label for="admin-email">Email</label>
                <input type="email" id="admin-email" placeholder="Enter admin email">
            </div>
            <div class="form-group">
                <label for="admin-password">Password</label>
                <input type="password" id="admin-password" placeholder="Enter admin password">
            </div>
            <button class="btn btn-block" onclick="login('admin')">Login</button>
            <p class="text-center mt-20"><a href="#" onclick="showMainPortal()">Back to Portal Selection</a></p>
        </div>
    </div>
    <footer class="footer">
        <p>¬© 2026 Sonargaon University. All rights reserved.</p>
        <p>Powered by FT Innovation</p>
        <p>Design & Developed by <a href="https://www.facebook.com/md.tasrik.hossain"
                class="text-decoration-none">Tasrik Hossain</a> | Fahmida Mim</p>
    </footer>

    <script>
        // Firebase configuration and initialization remains the same
        const firebaseConfig = {
            apiKey: "AIzaSyAs-qq9UFkLCFLAv2HnxkNjKeBZVmsh09A",
            authDomain: "ft-garden-city.firebaseapp.com",
            databaseURL: "https://ft-garden-city-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ft-garden-city",
            storageBucket: "ft-garden-city.firebasestorage.app",
            messagingSenderId: "537366117539",
            appId: "1:537366117539:web:cedde001fab2298f381316"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();

        // Global variables remain the same
        let currentUser = null;
        let currentUserData = null;
        let selectedSeat = null;
        let selectedRoute = null;
        let selectedDirection = 'to-campus';
        let selectedStop = null;
        let unreadNotificationsCount = 0;

        // DOM Elements remain the same
        const mainPortal = document.getElementById('main-portal');
        const loginForms = document.getElementById('login-forms');
        const studentPortal = document.getElementById('student-portal');
        const driverPortal = document.getElementById('driver-portal');
        const adminPortal = document.getElementById('admin-portal');

        // Show main portal selection
        function showMainPortal() {
            mainPortal.classList.remove('hidden');
            loginForms.classList.add('hidden');
            studentPortal.classList.add('hidden');
            driverPortal.classList.add('hidden');
            adminPortal.classList.add('hidden');

            document.getElementById('student-login').classList.add('hidden');
            document.getElementById('driver-login').classList.add('hidden');
            document.getElementById('admin-login').classList.add('hidden');
        }

        // Show login form for specific portal
        function showLogin(portalType) {
            mainPortal.classList.add('hidden');
            loginForms.classList.remove('hidden');

            document.getElementById('student-login').classList.add('hidden');
            document.getElementById('driver-login').classList.add('hidden');
            document.getElementById('admin-login').classList.add('hidden');

            document.getElementById(`${portalType}-login`).classList.remove('hidden');
        }

        // NEW: Student ID based login function
        async function login(portalType) {
            let studentId, password, email;

            if (portalType === 'student') {
                studentId = document.getElementById('student-id').value;
                password = document.getElementById('student-password').value;

                if (!studentId || !password) {
                    alert('Please enter both Student ID and password');
                    return;
                }
            } else if (portalType === 'driver') {
                email = document.getElementById('driver-email-input').value;
                password = document.getElementById('driver-password-input').value;
            } else if (portalType === 'admin') {
                email = document.getElementById('admin-email').value;
                password = document.getElementById('admin-password').value;
            }

            if (portalType === 'student') {
                // Student ID based login
                try {
                    // Find student by studentId in Firestore
                    const studentQuery = await db.collection('users')
                        .where('studentId', '==', studentId)
                        .where('type', '==', 'student')
                        .get();

                    if (studentQuery.empty) {
                        alert('Student ID not found');
                        return;
                    }

                    const studentDoc = studentQuery.docs[0];
                    const studentData = studentDoc.data();

                    if (!studentData.email) {
                        alert('Student account not properly configured. Please contact administrator.');
                        return;
                    }

                    // Login with email and password
                    const userCredential = await auth.signInWithEmailAndPassword(studentData.email, password);
                    currentUser = userCredential.user;
                    currentUserData = studentData;

                    // Redirect to student portal
                    mainPortal.classList.add('hidden');
                    loginForms.classList.add('hidden');
                    studentPortal.classList.remove('hidden');
                    loadStudentData();
                    showStudentSection('dashboard');

                } catch (error) {
                    console.error('Student login error:', error);
                    let errorMessage = 'Login failed. ';

                    switch (error.code) {
                        case 'auth/user-not-found':
                            errorMessage += 'Student account not found.';
                            break;
                        case 'auth/wrong-password':
                            errorMessage += 'Incorrect password.';
                            break;
                        case 'auth/invalid-email':
                            errorMessage += 'Invalid student account configuration.';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage += 'Too many failed login attempts. Please try again later.';
                            break;
                        default:
                            errorMessage += error.message;
                    }

                    alert(errorMessage);
                }
            } else {
                // Existing email-based login for driver and admin
                if (!email || !password) {
                    alert('Please enter both email and password');
                    return;
                }

                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    currentUser = userCredential.user;

                    const userDoc = await db.collection('users').doc(currentUser.uid).get();
                    if (userDoc.exists) {
                        currentUserData = userDoc.data();

                        if (currentUserData.type !== portalType) {
                            alert('You do not have access to this portal');
                            await auth.signOut();
                            return;
                        }

                        mainPortal.classList.add('hidden');
                        loginForms.classList.add('hidden');

                        if (portalType === 'driver') {
                            driverPortal.classList.remove('hidden');
                            loadDriverData();
                            showDriverSection('dashboard');
                        } else if (portalType === 'admin') {
                            adminPortal.classList.remove('hidden');
                            loadAdminData();
                            showAdminSection('dashboard');
                        }
                    } else {
                        alert('User data not found. Please contact administrator.');
                        await auth.signOut();
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    let errorMessage = 'Login failed. ';

                    switch (error.code) {
                        case 'auth/user-not-found':
                            errorMessage += 'No user found with this email.';
                            break;
                        case 'auth/wrong-password':
                            errorMessage += 'Incorrect password.';
                            break;
                        case 'auth/invalid-email':
                            errorMessage += 'Invalid email address.';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage += 'Too many failed login attempts. Please try again later.';
                            break;
                        default:
                            errorMessage += error.message;
                    }

                    alert(errorMessage);
                }
            }
        }

        // NEW: Enhanced sample data initialization with Student ID login support
        async function initializeSampleData() {
            try {
                const adminQuery = await db.collection('users').where('email', '==', 'admin@su.edu').get();

                if (adminQuery.empty) {
                    console.log('Creating sample data...');

                    // Create admin user
                    try {
                        const adminCredential = await auth.createUserWithEmailAndPassword('admin@su.edu', 'admin123');
                        const adminUser = adminCredential.user;

                        await db.collection('users').doc(adminUser.uid).set({
                            name: 'System Administrator',
                            email: 'admin@su.edu',
                            type: 'admin',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        console.log('Admin user created successfully');
                    } catch (authError) {
                        console.log('Admin user might already exist in auth:', authError.message);
                    }

                    // Create sample driver
                    try {
                        const driverCredential = await auth.createUserWithEmailAndPassword('driver@su.edu', 'driver123');
                        const driverUser = driverCredential.user;

                        const driverData = {
                            name: 'John Driver',
                            email: 'driver@su.edu',
                            driverId: 'DRV001',
                            phone: '01712345678',
                            personalPhone: '01812345678',
                            type: 'driver',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        await db.collection('users').doc(driverUser.uid).set(driverData);
                        await db.collection('drivers').doc(driverUser.uid).set(driverData);

                        console.log('Driver user created successfully');

                        // Create sample bus with this driver
                        const busData = {
                            routeNo: 'R001',
                            routeName: 'Mirpur to SU Campus',
                            busNumber: 'BUS001',
                            driverId: driverUser.uid,
                            capacity: 40,
                            departureTime: '08:00',
                            departureTimeFromCampus: '16:00',
                            status: 'On the way',
                            stops: [
                                { name: 'Mirpur 10', time: '08:00', timeFromCampus: '16:00' },
                                { name: 'Mirpur 1', time: '08:15', timeFromCampus: '16:15' },
                                { name: 'Kazipara', time: '08:25', timeFromCampus: '16:25' },
                                { name: 'Shewrapara', time: '08:35', timeFromCampus: '16:35' },
                                { name: 'Agargaon', time: '08:45', timeFromCampus: '16:45' },
                                { name: 'SU Campus', time: '09:00', timeFromCampus: '17:00' }
                            ],
                            estimatedArrival: '09:15',
                            nextStop: 'Kazipara',
                            eta: 5,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        await db.collection('buses').add(busData);
                        console.log('Sample bus created with driver');

                    } catch (driverError) {
                        console.log('Driver user might already exist:', driverError.message);
                    }

                    // Create sample student - UPDATED FOR STUDENT ID LOGIN
                    try {
                        const studentEmail = 'student001@su.edu'; // Unique email for auth
                        const studentPassword = 'student123';
                        const studentId = 'STU001'; // Student ID for login

                        const studentCredential = await auth.createUserWithEmailAndPassword(studentEmail, studentPassword);
                        const studentUser = studentCredential.user;

                        const studentData = {
                            name: 'Test Student',
                            email: studentEmail,
                            studentId: studentId,
                            department: 'Computer Science',
                            batch: '2023',
                            phone: '01912345678',
                            route: 'R001',
                            selectedStop: 'Kazipara',
                            type: 'student',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        await db.collection('users').doc(studentUser.uid).set(studentData);

                        console.log('Student user created successfully with Student ID login support');
                    } catch (studentError) {
                        console.log('Student user might already exist:', studentError.message);
                    }

                    console.log('Sample data initialization completed');
                }
            } catch (error) {
                console.error('Error initializing sample data:', error);
            }
        }

        // Student section navigation - FIXED VERSION
        function showStudentSection(section) {
            // Hide all sections first
            const sections = document.querySelectorAll('.student-section');
            sections.forEach(sec => sec.classList.add('hidden'));

            // Show the requested section
            const targetSection = document.getElementById(`student-${section}-page`);
            if (targetSection) {
                targetSection.classList.remove('hidden');

                // Load notifications when notifications page is shown
                if (section === 'notifications') {
                    loadAllStudentNotifications();
                }
            }

            // Show the selected section
            document.getElementById(`student-${section}`).classList.remove('hidden');

            // Update active nav link
            document.querySelectorAll('#student-portal nav a').forEach(link => {
                link.classList.remove('active');
            });

            // Find and activate the correct nav link
            const navLinks = document.querySelectorAll('#student-portal nav a');
            for (let link of navLinks) {
                if (link.textContent.toLowerCase().includes(section) ||
                    (section === 'notifications' && link.textContent.toLowerCase().includes('notification'))) {
                    link.classList.add('active');
                    break;
                }
            }

            // Load section-specific data
            if (section === 'tracking') {
                loadStudentTracking();
            } else if (section === 'booking') {
                loadBookingData();
            } else if (section === 'profile') {
                loadStudentProfile();
            } else if (section === 'notifications') {
                loadAllStudentNotifications(); // This is now fixed
            }

        }

        // Load student data
        async function loadStudentData() {
            if (!currentUserData) return;

            // Update welcome message and avatar
            document.getElementById('student-welcome').textContent = `Welcome, ${currentUserData.name || 'Student'}!`;
            document.getElementById('student-avatar').textContent = currentUserData.name ? currentUserData.name.charAt(0).toUpperCase() : 'S';
            document.getElementById('student-id-display').textContent = `ID: ${currentUserData.studentId || 'N/A'}`;

            // Load bus information
            await loadStudentBusInfo();

            // Load seat information
            await loadStudentSeatInfo();

            // Load available buses
            await loadAvailableBuses();

            // Load notifications
            await loadStudentNotifications();

            // FIXED: Load unread notifications count
            async function loadUnreadNotificationsCount() {
                try {
                    // For demo purposes, we'll use a simple count
                    // In a real app, you would track read/unread status per user
                    const notificationsSnapshot = await db.collection('notifications')
                        .orderBy('timestamp', 'desc')
                        .limit(20)
                        .get();

                    let count = 0;
                    const oneWeekAgo = new Date();
                    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

                    notificationsSnapshot.forEach(doc => {
                        const notification = doc.data();
                        const notificationTime = notification.timestamp ? notification.timestamp.toDate() : new Date();

                        // Count recent notifications (last 7 days) that are relevant to the user
                        if (notificationTime >= oneWeekAgo) {
                            if (notification.audience &&
                                (notification.audience.includes('all') ||
                                    notification.audience.includes('students') ||
                                    (currentUserData.route && notification.audience.includes(currentUserData.route)))) {
                                count++;
                            }
                        }
                    });

                    unreadNotificationsCount = count;
                    const notificationBadge = document.getElementById('notification-badge');

                    if (unreadNotificationsCount > 0 && notificationBadge) {
                        notificationBadge.textContent = unreadNotificationsCount;
                        notificationBadge.classList.remove('hidden');
                    } else if (notificationBadge) {
                        notificationBadge.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Error loading unread notifications count:', error);
                }
            }

        }

        // Load student bus information - FIXED VERSION
        async function loadStudentBusInfo() {
            if (!currentUserData.route) return;

            try {
                const busDoc = await db.collection('buses').where('routeNo', '==', currentUserData.route).get();
                if (!busDoc.empty) {
                    const busData = busDoc.docs[0].data();

                    // Get driver info
                    let driverName = 'N/A';
                    let driverPhone = 'N/A';
                    if (busData.driverId) {
                        const driverDoc = await db.collection('drivers').doc(busData.driverId).get();
                        if (driverDoc.exists) {
                            const driver = driverDoc.data();
                            driverName = driver.name;
                            driverPhone = driver.phone;
                        }
                    }

                    // Calculate estimated arrival for both directions
                    let estimatedArrivalToCampus = 'N/A';
                    let estimatedArrivalFromCampus = 'N/A';

                    if (currentUserData.selectedStop) {
                        estimatedArrivalToCampus = calculateEstimatedArrival(busData, currentUserData.selectedStop, 'to-campus');
                        estimatedArrivalFromCampus = calculateEstimatedArrival(busData, currentUserData.selectedStop, 'from-campus');
                    }

                    const busInfoHTML = `
                <h4>Route ${busData.routeNo} - ${busData.routeName}</h4>
                <p>Bus: ${busData.busNumber}</p>
                <p>Driver: ${driverName}</p>
                <p>Driver Phone: ${driverPhone}</p>
                <p>Departure to Campus: ${busData.departureTime || 'N/A'}</p>
                <p>Departure from Campus: ${busData.departureTimeFromCampus || 'N/A'}</p>
                <div class="estimated-arrival-info">
                    <p><strong>Estimated Arrival at ${currentUserData.selectedStop || 'your stop'}:</strong></p>
                    <p>To Campus: <span class="bus-status ${busData.status === 'Delayed' ? 'status-delayed' : 'status-ontime'}">${estimatedArrivalToCampus} ${busData.status === 'Delayed' ? '(Delayed)' : ''}</span></p>
                    <p>From Campus: <span class="bus-status ${busData.status === 'Delayed' ? 'status-delayed' : 'status-ontime'}">${estimatedArrivalFromCampus} ${busData.status === 'Delayed' ? '(Delayed)' : ''}</span></p>
                </div>
            `;

                    document.getElementById('student-bus-info').innerHTML = busInfoHTML;
                } else {
                    document.getElementById('student-bus-info').innerHTML = '<p>No bus information available</p>';
                }
            } catch (error) {
                console.error('Error loading bus info:', error);
                document.getElementById('student-bus-info').innerHTML = '<p>Error loading bus information</p>';
            }
        }

        // Calculate estimated arrival for a specific stop and direction - FIXED VERSION
        function calculateEstimatedArrival(busData, stopName, direction) {
            if (!busData.stops || !Array.isArray(busData.stops)) return 'N/A';

            const stop = busData.stops.find(s => s.name === stopName);
            if (!stop) return 'N/A';

            // Use the appropriate time based on direction
            if (direction === 'to-campus') {
                return stop.time || 'N/A';
            } else {
                return stop.timeFromCampus || 'N/A';
            }
        }

        // Helper function to get stop time - FIXED VERSION
        async function getStopTime(routeNo, stopName, direction) {
            try {
                const busDoc = await db.collection('buses').where('routeNo', '==', routeNo).get();
                if (!busDoc.empty) {
                    const busData = busDoc.docs[0].data();
                    if (busData.stops && Array.isArray(busData.stops)) {
                        const stop = busData.stops.find(s => s.name === stopName);
                        if (stop) {
                            return direction === 'to-campus' ? (stop.time || 'N/A') : (stop.timeFromCampus || 'N/A');
                        }
                    }
                }
            } catch (error) {
                console.error('Error getting stop time:', error);
            }
            return 'N/A';
        }

        // Seat number to label mapping
        const seatNumberToLabel = {
            1: 'A1', 2: 'A2', 3: 'B1', 4: 'B2', 5: 'C1', 6: 'C2', 7: 'C3', 8: 'C4',
            9: 'D1', 10: 'D2', 11: 'D3', 12: 'D4', 13: 'E1', 14: 'E2', 15: 'E3', 16: 'E4',
            17: 'F1', 18: 'F2', 19: 'F3', 20: 'F4', 21: 'G1', 22: 'G2', 23: 'G3', 24: 'G4',
            25: 'H1', 26: 'H2', 27: 'H3', 28: 'H4', 29: 'I1', 30: 'I2', 31: 'I3', 32: 'I4',
            33: 'J1', 34: 'J2', 35: 'J3', 36: 'J4', 37: 'K1', 38: 'K2', 39: 'K3', 40: 'K4', 41: 'K5'
        };

        // Load student seat information - FIXED VERSION
        async function loadStudentSeatInfo() {
            if (!currentUserData.studentId) return;

            try {
                // Get today's date in YYYY-MM-DD format
                const today = new Date().toISOString().split('T')[0];

                // Get bookings for both directions
                const toCampusBookings = await db.collection('bookings')
                    .where('studentId', '==', currentUserData.studentId)
                    .where('date', '==', today)
                    .where('direction', '==', 'to-campus')
                    .get();

                const fromCampusBookings = await db.collection('bookings')
                    .where('studentId', '==', currentUserData.studentId)
                    .where('date', '==', today)
                    .where('direction', '==', 'from-campus')
                    .get();

                let seatInfoHTML = '';

                // Check if student has bookings for either direction
                if (!toCampusBookings.empty || !fromCampusBookings.empty) {
                    seatInfoHTML = '<div class="seat-booking-info">';

                    // To Campus booking
                    if (!toCampusBookings.empty) {
                        const booking = toCampusBookings.docs[0].data();
                        const seatLabel = seatNumberToLabel[parseInt(booking.seatNumber)] || booking.seatNumber;

                        seatInfoHTML += `
                    <div class="direction-booking">
                        <h4>Stops to SU Campus</h4>
                        <p>Your Seat: <strong>${seatLabel}</strong></p>
                        <p>Route: ${booking.routeNo}</p>
                        <p>Stop: ${booking.stop || 'N/A'}</p>
                        <p>Departure Time: ${await getStopTime(booking.routeNo, booking.stop, 'to-campus')}</p>
                        <p>Status: <span class="bus-status status-ontime">Confirmed</span></p>
                        <button class="btn btn-danger mt-10" onclick="cancelBooking('${toCampusBookings.docs[0].id}')">Cancel Booking</button>
                    </div>
                `;
                    } else {
                        seatInfoHTML += `
                    <div class="direction-booking">
                        <h4>Stops to SU Campus</h4>
                        <p>No seat booked</p>
                        <button class="btn btn-success mt-10" onclick="showStudentSection('booking')">Book a Seat</button>
                    </div>
                `;
                    }

                    // From Campus booking
                    if (!fromCampusBookings.empty) {
                        const booking = fromCampusBookings.docs[0].data();
                        const seatLabel = seatNumberToLabel[parseInt(booking.seatNumber)] || booking.seatNumber;

                        seatInfoHTML += `
                    <div class="direction-booking">
                        <h4>SU Campus to Stops</h4>
                        <p>Your Seat: <strong>${seatLabel}</strong></p>
                        <p>Route: ${booking.routeNo}</p>
                        <p>Stop: ${booking.stop || 'N/A'}</p>
                        <p>Departure Time: ${await getStopTime(booking.routeNo, booking.stop, 'from-campus')}</p>
                        <p>Status: <span class="bus-status status-ontime">Confirmed</span></p>
                        <button class="btn btn-danger mt-10" onclick="cancelBooking('${fromCampusBookings.docs[0].id}')">Cancel Booking</button>
                    </div>
                `;
                    } else {
                        seatInfoHTML += `
                    <div class="direction-booking">
                        <h4>SU Campus to Stops</h4>
                        <p>No seat booked</p>
                        <button class="btn btn-success mt-10" onclick="showStudentSection('booking')">Book a Seat</button>
                    </div>
                `;
                    }

                    seatInfoHTML += '</div>';
                } else {
                    seatInfoHTML = `
                <p>No seat booked for today</p>
                <button class="btn btn-success mt-20" onclick="showStudentSection('booking')">Book a Seat</button>
            `;
                }

                document.getElementById('student-seat-info').innerHTML = seatInfoHTML;
            } catch (error) {
                console.error('Error loading seat info:', error);
                document.getElementById('student-seat-info').innerHTML = '<p>Error loading seat information</p>';
            }
        }

        // Helper function to get stop time
        async function getStopTime(routeNo, stopName, direction) {
            try {
                const busDoc = await db.collection('buses').where('routeNo', '==', routeNo).get();
                if (!busDoc.empty) {
                    const busData = busDoc.docs[0].data();
                    if (busData.stops && Array.isArray(busData.stops)) {
                        const stop = busData.stops.find(s => s.name === stopName);
                        if (stop) {
                            return direction === 'to-campus' ? stop.time : stop.timeFromCampus;
                        }
                    }
                }
            } catch (error) {
                console.error('Error getting stop time:', error);
            }
            return 'N/A';
        }

        // Load available buses
        async function loadAvailableBuses() {
            try {
                const busesSnapshot = await db.collection('buses').get();
                let busesHTML = '';

                busesSnapshot.forEach(doc => {
                    const bus = doc.data();
                    busesHTML += `
                        <li class="bus-item">
                            <div class="bus-info">
                                <h4>Route ${bus.routeNo} - ${bus.routeName}</h4>
                                <p>Bus: ${bus.busNumber}</p>
                            </div>
                            <span class="bus-status ${bus.status === 'Delayed' ? 'status-delayed' : 'status-ontime'}">${bus.status === 'Delayed' ? 'Delayed' : 'On Time'}</span>
                        </li>
                    `;
                });

                document.getElementById('student-bus-list').innerHTML = busesHTML;
            } catch (error) {
                console.error('Error loading buses:', error);
                document.getElementById('student-bus-list').innerHTML = '<p>Error loading bus information</p>';
            }
        }

        // Load student notifications
        async function loadStudentNotifications() {
            try {
                const notificationsSnapshot = await db.collection('notifications')
                    .where('audience', 'in', [['all'], ['students']])
                    .orderBy('timestamp', 'desc')
                    .limit(5)
                    .get();

                let notificationsHTML = '';

                notificationsSnapshot.forEach(doc => {
                    const notification = doc.data();
                    const timestamp = notification.timestamp ? new Date(notification.timestamp.toDate()).toLocaleString() : 'Unknown time';
                    notificationsHTML += `
                        <div class="notification">
                            <strong>${notification.title}</strong> - ${notification.message} (${timestamp})
                        </div>
                    `;
                });

                document.getElementById('student-notifications').innerHTML = notificationsHTML;
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        // FIXED: Load all student notifications for notifications page
        async function loadAllStudentNotifications() {
            try {
                console.log('Loading all student notifications...');

                // Show loading state
                document.getElementById('student-all-notifications').innerHTML = `
            <div class="spinner-container">
                <div class="spinner"></div>
                <p>Loading notifications...</p>
            </div>
        `;

                // Get current user data first
                if (!currentUserData) {
                    console.error('No user data available');
                    throw new Error('User data not available');
                }

                console.log('Current user data:', currentUserData);
                console.log('User route:', currentUserData.route);

                // Get all notifications
                const notificationsSnapshot = await db.collection('notifications')
                    .orderBy('timestamp', 'desc')
                    .get();

                console.log('Total notifications found:', notificationsSnapshot.size);

                let notificationsHTML = '';
                let hasNotifications = false;

                if (notificationsSnapshot.empty) {
                    notificationsHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üì≠</div>
                    <p>No notifications available</p>
                </div>
            `;
                } else {
                    // Filter notifications client-side
                    notificationsSnapshot.forEach(doc => {
                        const notification = doc.data();
                        console.log('Processing notification:', notification);

                        // Check if notification is for this student
                        const isForStudent = notification.audience &&
                            (notification.audience.includes('all') ||
                                notification.audience.includes('students') ||
                                (currentUserData.route && notification.audience.includes(currentUserData.route)));

                        console.log('Is for student:', isForStudent, 'Audience:', notification.audience);

                        if (isForStudent) {
                            hasNotifications = true;
                            const timestamp = notification.timestamp ?
                                new Date(notification.timestamp.toDate()).toLocaleString() : 'Unknown time';

                            // Determine notification type class
                            let typeClass = '';
                            let typeText = notification.type || 'General';

                            if (notification.type === 'Emergency') {
                                typeClass = 'emergency';
                            } else if (notification.type === 'Delay' || notification.type === 'Route Change') {
                                typeClass = 'warning';
                            } else if (notification.type === 'General') {
                                typeClass = 'success';
                            }

                            notificationsHTML += `
                        <div class="notification-item ${typeClass}">
                            <div class="notification-header">
                                <div class="notification-title">${notification.title || 'No Title'}</div>
                                <span class="notification-type">${typeText}</span>
                            </div>
                            <div class="notification-message">${notification.message || 'No message content'}</div>
                            <div class="notification-meta">
                                <span>From: ${notification.sender || 'System'}</span>
                                <span>${timestamp}</span>
                            </div>
                        </div>
                    `;
                        }
                    });

                    if (!hasNotifications) {
                        notificationsHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No notifications available for you</p>
                        <p class="small-text">Your route: ${currentUserData.route || 'Not assigned'}</p>
                    </div>
                `;
                    }
                }

                document.getElementById('student-all-notifications').innerHTML = notificationsHTML;
                console.log('Notifications loaded successfully');

                // Mark notifications as read
                await markNotificationsAsRead();

            } catch (error) {
                console.error('Error loading all notifications:', error);
                document.getElementById('student-all-notifications').innerHTML = `
            <div class="error-state">
                <div class="error-icon">‚ùå</div>
                <h3>Error Loading Notifications</h3>
                <p>${error.message}</p>
                <button class="btn mt-20" onclick="loadAllStudentNotifications()">Try Again</button>
            </div>
        `;
            }
        }

        // FIXED: Mark notifications as read function
        async function markNotificationsAsRead() {
            try {
                // Reset notification badge
                unreadNotificationsCount = 0;
                const notificationBadge = document.getElementById('notification-badge');
                if (notificationBadge) {
                    notificationBadge.classList.add('hidden');
                    notificationBadge.textContent = '0';
                }

                console.log('Notifications marked as read');
            } catch (error) {
                console.error('Error marking notifications as read:', error);
            }
        }

        // FIXED: Mark all notifications as read
        async function markAllNotificationsAsRead() {
            try {
                // Reset notification badge
                unreadNotificationsCount = 0;
                const notificationBadge = document.getElementById('notification-badge');
                if (notificationBadge) {
                    notificationBadge.classList.add('hidden');
                    notificationBadge.textContent = '0';
                }

                // Show success message
                showNotification('All notifications marked as read', 'success');
                console.log('All notifications marked as read');

            } catch (error) {
                console.error('Error marking all notifications as read:', error);
                showNotification('Error marking notifications as read', 'error');
            }
        }

        // Helper function to show notifications
        function showNotification(message, type = 'info') {
            // You can implement a toast notification system here
            alert(message); // Temporary solution
        }

        // FIXED: Load student notifications for dashboard - SHOW NOTHING IN DASHBOARD
        async function loadStudentNotifications() {
            try {
                console.log('Loading student notifications for dashboard...');

                // Clear dashboard notifications - show nothing
                document.getElementById('student-notifications').innerHTML = '';

                // Update notification badge count only
                await updateNotificationBadgeCount();

            } catch (error) {
                console.error('Error loading notifications:', error);
                document.getElementById('student-notifications').innerHTML = '';
            }
        }

        // NEW: Update notification badge count only
        async function updateNotificationBadgeCount() {
            try {
                // Get all notifications and filter client-side
                const notificationsSnapshot = await db.collection('notifications')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();

                let notificationCount = 0;

                notificationsSnapshot.forEach(doc => {
                    const notification = doc.data();
                    // Client-side filtering
                    if (notification.audience &&
                        (notification.audience.includes('all') ||
                            notification.audience.includes('students') ||
                            (currentUserData.route && notification.audience.includes(currentUserData.route)))) {
                        notificationCount++;
                    }
                });

                // Update notification badge
                unreadNotificationsCount = notificationCount;
                const notificationBadge = document.getElementById('notification-badge');

                if (unreadNotificationsCount > 0 && notificationBadge) {
                    notificationBadge.textContent = unreadNotificationsCount;
                    notificationBadge.classList.remove('hidden');
                } else if (notificationBadge) {
                    notificationBadge.classList.add('hidden');
                }

            } catch (error) {
                console.error('Error updating notification badge:', error);
            }
        }

        // FIXED: Mark notifications as read function
        async function markNotificationsAsRead() {
            try {
                // Reset notification badge
                unreadNotificationsCount = 0;
                const notificationBadge = document.getElementById('notification-badge');
                if (notificationBadge) {
                    notificationBadge.classList.add('hidden');
                    notificationBadge.textContent = '0';
                }

                console.log('Notifications marked as read');
            } catch (error) {
                console.error('Error marking notifications as read:', error);
            }
        }

        // FIXED: Mark all notifications as read
        async function markAllNotificationsAsRead() {
            try {
                // Reset notification badge
                unreadNotificationsCount = 0;
                const notificationBadge = document.getElementById('notification-badge');
                if (notificationBadge) {
                    notificationBadge.classList.add('hidden');
                    notificationBadge.textContent = '0';
                }

                alert('All notifications marked as read');
                console.log('All notifications marked as read');

                // Reload notifications to show they're read
                await loadAllStudentNotifications();
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
            }
        }

        // Load student tracking
        async function loadStudentTracking() {
            if (!currentUserData.route) return;

            try {
                const busDoc = await db.collection('buses').where('routeNo', '==', currentUserData.route).get();
                if (!busDoc.empty) {
                    const busData = busDoc.docs[0].data();

                    // Get driver info
                    let driverName = 'N/A';
                    let driverPhone = 'N/A';
                    if (busData.driverId) {
                        const driverDoc = await db.collection('drivers').doc(busData.driverId).get();
                        if (driverDoc.exists) {
                            const driver = driverDoc.data();
                            driverName = driver.name;
                            driverPhone = driver.phone;
                        }
                    }

                    // Update tracking route title
                    document.getElementById('tracking-route-title').textContent = `Route ${busData.routeNo} - ${busData.routeName}`;

                    // Update tracking status
                    document.getElementById('tracking-status').innerHTML = `
                        <span class="bus-status ${busData.status === 'Delayed' ? 'status-delayed' : 'status-ontime'}">${busData.status}</span>
                    `;

                    // Update bus details with enhanced information
                    const busDetailsHTML = `
                        <h4>Bus Details</h4>
                        <div class="bus-details-grid">
                            <div class="detail-item">
                                <div class="detail-label">Bus Number</div>
                                <div class="detail-value">${busData.busNumber}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Route Number</div>
                                <div class="detail-value">${busData.routeNo}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Route Name</div>
                                <div class="detail-value">${busData.routeName}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Driver Name</div>
                                <div class="detail-value">${driverName}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Driver Phone</div>
                                <div class="detail-value">${driverPhone}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Departure Time</div>
                                <div class="detail-value">${busData.departureTime || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Estimated Arrival</div>
                                <div class="detail-value">${busData.estimatedArrival || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Next Stop</div>
                                <div class="detail-value">${busData.nextStop || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">ETA to Next Stop</div>
                                <div class="detail-value">${busData.eta ? `${busData.eta} min` : 'N/A'}</div>
                            </div>
                        </div>
                    `;

                    document.getElementById('tracking-bus-details').innerHTML = busDetailsHTML;
                } else {
                    document.getElementById('tracking-bus-details').innerHTML = '<p>No bus information available for tracking</p>';
                }
            } catch (error) {
                console.error('Error loading tracking data:', error);
                document.getElementById('tracking-bus-details').innerHTML = '<p>Error loading tracking information</p>';
            }
        }

        // Load booking data
        async function loadBookingData() {
            try {
                // Load available routes
                const routesSnapshot = await db.collection('buses').get();
                const routeSelect = document.getElementById('route-select');
                routeSelect.innerHTML = '<option value="">-- Select Route --</option>';

                routesSnapshot.forEach(doc => {
                    const bus = doc.data();
                    const option = document.createElement('option');
                    option.value = bus.routeNo;
                    option.textContent = `Route ${bus.routeNo} - ${bus.routeName}`;
                    routeSelect.appendChild(option);
                });

                // Reset other fields
                document.getElementById('stop-select').innerHTML = '<option value="">-- Select Stop --</option>';
                document.getElementById('seat-map-container').innerHTML = '<p>Please select a route first</p>';
                document.getElementById('confirm-booking-btn').disabled = true;
                document.getElementById('booking-time-info').classList.add('hidden');
            } catch (error) {
                console.error('Error loading booking data:', error);
            }
        }

        // Select direction for booking
        function selectDirection(direction) {
            selectedDirection = direction;

            // Update UI
            document.getElementById('direction-to-campus').classList.toggle('active', direction === 'to-campus');
            document.getElementById('direction-from-campus').classList.toggle('active', direction === 'from-campus');

            // Reset selection
            selectedSeat = null;
            document.getElementById('confirm-booking-btn').disabled = true;

            // Update stops if a route is selected
            if (selectedRoute) {
                loadStopsForRoute(selectedRoute);
                // Reload seats for the new direction
                loadAvailableSeats(selectedRoute, 40);
            }

            // Update booking time info
            updateBookingTimeInfo();
        }

        // Load seats for selected route
        async function loadSeatsForRoute() {
            const routeSelect = document.getElementById('route-select');
            selectedRoute = routeSelect.value;

            if (!selectedRoute) {
                document.getElementById('seat-map-container').innerHTML = '<p>Please select a route first</p>';
                document.getElementById('stop-select').innerHTML = '<option value="">-- Select Stop --</option>';
                document.getElementById('confirm-booking-btn').disabled = true;
                return;
            }

            try {
                // Load bus data for the selected route
                const busDoc = await db.collection('buses').where('routeNo', '==', selectedRoute).get();
                if (!busDoc.empty) {
                    const busData = busDoc.docs[0].data();

                    // Load stops for the route
                    loadStopsForRoute(selectedRoute);

                    // Load available seats
                    await loadAvailableSeats(selectedRoute, busData.capacity || 40);

                    // Update booking time info
                    updateBookingTimeInfo();
                }
            } catch (error) {
                console.error('Error loading route data:', error);
            }
        }

        // Load stops for selected route
        async function loadStopsForRoute(routeNo) {
            try {
                const busDoc = await db.collection('buses').where('routeNo', '==', routeNo).get();
                if (!busDoc.empty) {
                    const busData = busDoc.docs[0].data();
                    const stopSelect = document.getElementById('stop-select');
                    stopSelect.innerHTML = '<option value="">-- Select Stop --</option>';

                    if (busData.stops && Array.isArray(busData.stops)) {
                        busData.stops.forEach(stop => {
                            const option = document.createElement('option');
                            option.value = stop.name;
                            option.textContent = stop.name;
                            stopSelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading stops:', error);
            }
        }

        // Update estimated arrival when stop is selected
        function updateEstimatedArrival() {
            const stopSelect = document.getElementById('stop-select');
            selectedStop = stopSelect.value;

            if (selectedRoute && selectedStop) {
                updateBookingTimeInfo();
            }
        }

        // Update booking time information - FIXED VERSION
        async function updateBookingTimeInfo() {
            if (!selectedRoute || !selectedStop) return;

            try {
                const busDoc = await db.collection('buses').where('routeNo', '==', selectedRoute).get();
                if (!busDoc.empty) {
                    const busData = busDoc.docs[0].data();
                    const bookingTimeInfo = document.getElementById('booking-time-info');

                    // Find the selected stop
                    const stop = busData.stops.find(s => s.name === selectedStop);
                    if (stop) {
                        const departureTime = selectedDirection === 'to-campus' ?
                            busData.departureTime : busData.departureTimeFromCampus;

                        const arrivalTime = selectedDirection === 'to-campus' ?
                            stop.time : stop.timeFromCampus;

                        let message = '';
                        let className = '';

                        if (selectedDirection === 'to-campus') {
                            message = `You can book a seat until ${departureTime}. The bus will arrive at ${selectedStop} at approximately ${arrivalTime}.`;
                            className = 'warning';
                        } else {
                            message = `You can book a seat until ${departureTime}. The bus will depart from SU Campus at ${departureTime} and arrive at ${selectedStop} at approximately ${arrivalTime}.`;
                            className = 'warning';
                        }

                        bookingTimeInfo.innerHTML = message;
                        bookingTimeInfo.className = `booking-time-info ${className}`;
                        bookingTimeInfo.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Error updating booking time info:', error);
            }
        }

        // Load available seats - FIXED VERSION
        async function loadAvailableSeats(routeNo, capacity) {
            try {
                // Get today's date in YYYY-MM-DD format
                const today = new Date().toISOString().split('T')[0];

                // Get bookings for this route and date
                const bookingsSnapshot = await db.collection('bookings')
                    .where('routeNo', '==', routeNo)
                    .where('date', '==', today)
                    .where('direction', '==', selectedDirection)
                    .get();

                const bookedSeats = new Set();
                bookingsSnapshot.forEach(doc => {
                    const booking = doc.data();
                    bookedSeats.add(booking.seatNumber.toString());
                });

                console.log(`Booked seats for ${routeNo}, ${selectedDirection}:`, Array.from(bookedSeats));

                // Generate seat map based on Driver.jpg layout
                const seatMapHTML = generateSeatMap(bookedSeats, capacity);

                document.getElementById('seat-map-container').innerHTML = seatMapHTML;

                // Reset selection
                selectedSeat = null;
                document.getElementById('confirm-booking-btn').disabled = true;
            } catch (error) {
                console.error('Error loading available seats:', error);
                document.getElementById('seat-map-container').innerHTML = '<p>Error loading seat information</p>';
            }
        }

        // Generate seat map based on the new layout - FIXED VERSION
        function generateSeatMap(bookedSeats, capacity) {
            let seatMapHTML = `
        <div class="bus-layout">
            <!-- First Row: A1, A2 on left side -->
            <div class="front-row-a">
                <div class="seat ${bookedSeats.has('1') ? 'seat-booked' : 'seat-available'}" data-seat="1" ${bookedSeats.has('1') ? '' : 'onclick="selectSeat(1)"'}>A1</div>
                <div class="seat ${bookedSeats.has('2') ? 'seat-booked' : 'seat-available'}" data-seat="2" ${bookedSeats.has('2') ? '' : 'onclick="selectSeat(2)"'}>A2</div>
                <div class="empty-space"></div>
                <div class="empty-space"></div>
                <div class="empty-space"></div>
            </div>
            
            <!-- Second Row: B1, B2 on left, DRIVER on right -->
            <div class="front-row-b">
                <div class="seat ${bookedSeats.has('3') ? 'seat-booked' : 'seat-available'}" data-seat="3" ${bookedSeats.has('3') ? '' : 'onclick="selectSeat(3)"'}>B1</div>
                <div class="seat ${bookedSeats.has('4') ? 'seat-booked' : 'seat-available'}" data-seat="4" ${bookedSeats.has('4') ? '' : 'onclick="selectSeat(4)"'}>B2</div>
                <div class="empty-space"></div>
                <div class="empty-space"></div>
                <div class="driver-section">DRIVER</div>
            </div>
            
            <!-- Door section on left side -->
            <div class="door-section">DOOR</div>
            
            <!-- Main seating area with 5 columns -->
            <div class="seats-grid">
    `;

            // Define seat layout according to the new arrangement
            const seatLayout = [
                // Row C (4 seats: 2 on left, 2 on right)
                { label: 'C1', number: 5, col: 1 },
                { label: 'C2', number: 6, col: 2 },
                { label: '', number: 0, col: 3, empty: true }, // Empty middle column
                { label: 'C3', number: 7, col: 4 },
                { label: 'C4', number: 8, col: 5 },

                // Row D
                { label: 'D1', number: 9, col: 1 },
                { label: 'D2', number: 10, col: 2 },
                { label: '', number: 0, col: 3, empty: true },
                { label: 'D3', number: 11, col: 4 },
                { label: 'D4', number: 12, col: 5 },

                // Row E
                { label: 'E1', number: 13, col: 1 },
                { label: 'E2', number: 14, col: 2 },
                { label: '', number: 0, col: 3, empty: true },
                { label: 'E3', number: 15, col: 4 },
                { label: 'E4', number: 16, col: 5 },

                // Row F
                { label: 'F1', number: 17, col: 1 },
                { label: 'F2', number: 18, col: 2 },
                { label: '', number: 0, col: 3, empty: true },
                { label: 'F3', number: 19, col: 4 },
                { label: 'F4', number: 20, col: 5 },

                // Row G
                { label: 'G1', number: 21, col: 1 },
                { label: 'G2', number: 22, col: 2 },
                { label: '', number: 0, col: 3, empty: true },
                { label: 'G3', number: 23, col: 4 },
                { label: 'G4', number: 24, col: 5 },

                // Row H
                { label: 'H1', number: 25, col: 1 },
                { label: 'H2', number: 26, col: 2 },
                { label: '', number: 0, col: 3, empty: true },
                { label: 'H3', number: 27, col: 4 },
                { label: 'H4', number: 28, col: 5 },

                // Row I
                { label: 'I1', number: 29, col: 1 },
                { label: 'I2', number: 30, col: 2 },
                { label: '', number: 0, col: 3, empty: true },
                { label: 'I3', number: 31, col: 4 },
                { label: 'I4', number: 32, col: 5 },

                // Row J
                { label: 'J1', number: 33, col: 1 },
                { label: 'J2', number: 34, col: 2 },
                { label: '', number: 0, col: 3, empty: true },
                { label: 'J3', number: 35, col: 4 },
                { label: 'J4', number: 36, col: 5 },

                // Row K (special arrangement with K3 in the middle)
                { label: 'K1', number: 37, col: 1 },
                { label: 'K2', number: 38, col: 2 },
                { label: 'K3', number: 39, col: 3 },
                { label: 'K4', number: 40, col: 4 },
                { label: 'K5', number: 41, col: 5 }
            ];

            // Create the seat grid based on the layout
            seatLayout.forEach(item => {
                if (item.empty) {
                    seatMapHTML += `<div class="empty-space"></div>`;
                } else {
                    const isBooked = bookedSeats.has(item.number.toString());
                    const seatClass = isBooked ? 'seat-booked' : 'seat-available';
                    const onClick = isBooked ? '' : `onclick="selectSeat(${item.number})"`;

                    // Handle special case for K3 (placed in the middle column)
                    if (item.label === 'K3') {
                        seatMapHTML += `
                    <div class="seat ${seatClass} k3-seat" data-seat="${item.number}" ${onClick}>
                        ${item.label}
                    </div>
                `;
                    } else {
                        seatMapHTML += `
                    <div class="seat ${seatClass}" data-seat="${item.number}" ${onClick}>
                        ${item.label}
                    </div>
                `;
                    }
                }
            });

            seatMapHTML += `
            </div>
        </div>
    `;

            return seatMapHTML;
        }

        // Select seat function
        function selectSeat(seatNumber) {
            // Reset previously selected seat
            if (selectedSeat) {
                const prevSeat = document.querySelector(`[data-seat="${selectedSeat}"]`);
                if (prevSeat && !prevSeat.classList.contains('seat-booked')) {
                    prevSeat.classList.remove('seat-selected');
                    prevSeat.classList.add('seat-available');
                }
            }

            // Select new seat
            selectedSeat = seatNumber;
            const seatElement = document.querySelector(`[data-seat="${seatNumber}"]`);

            if (seatElement && !seatElement.classList.contains('seat-booked')) {
                seatElement.classList.remove('seat-available');
                seatElement.classList.add('seat-selected');

                // Enable confirm button
                document.getElementById('confirm-booking-btn').disabled = false;

                console.log(`Seat ${seatNumber} selected`);
            }
        }

        // Confirm booking - FIXED VERSION
        async function confirmBooking() {
            if (!selectedRoute || !selectedSeat || !selectedStop) {
                alert('Please select a route, stop, and seat before confirming your booking.');
                return;
            }

            try {
                // Check if seat is still available
                const today = new Date().toISOString().split('T')[0];
                const existingBooking = await db.collection('bookings')
                    .where('routeNo', '==', selectedRoute)
                    .where('date', '==', today)
                    .where('direction', '==', selectedDirection)
                    .where('seatNumber', '==', selectedSeat.toString())
                    .get();

                if (!existingBooking.empty) {
                    alert('Sorry, this seat has just been booked by someone else. Please select another seat.');
                    await loadAvailableSeats(selectedRoute, 40); // Refresh seat map
                    return;
                }

                // Get stop time
                const stopTime = await getStopTime(selectedRoute, selectedStop, selectedDirection);
                const seatLabel = seatNumberToLabel[selectedSeat] || selectedSeat.toString();

                // Create booking
                const bookingData = {
                    studentId: currentUserData.studentId,
                    studentName: currentUserData.name,
                    routeNo: selectedRoute,
                    direction: selectedDirection,
                    stop: selectedStop,
                    stopTime: stopTime,
                    seatNumber: selectedSeat.toString(),
                    seatLabel: seatLabel,
                    date: today,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'confirmed'
                };

                await db.collection('bookings').add(bookingData);

                alert(`Booking confirmed! Seat ${seatLabel} on Route ${selectedRoute} (${selectedDirection === 'to-campus' ? 'Stops to SU Campus' : 'SU Campus to Stops'}) has been reserved for you.`);

                // Reset booking form
                selectedSeat = null;
                selectedRoute = null;
                selectedStop = null;
                document.getElementById('route-select').value = '';
                document.getElementById('stop-select').innerHTML = '<option value="">-- Select Stop --</option>';
                document.getElementById('seat-map-container').innerHTML = '<p>Please select a route first</p>';
                document.getElementById('confirm-booking-btn').disabled = true;
                document.getElementById('booking-time-info').classList.add('hidden');

                // Return to dashboard
                showStudentSection('dashboard');
            } catch (error) {
                console.error('Error confirming booking:', error);
                alert('Error confirming booking. Please try again.');
            }
        }

        // Cancel booking
        async function cancelBooking(bookingId) {
            if (confirm('Are you sure you want to cancel this booking?')) {
                try {
                    await db.collection('bookings').doc(bookingId).delete();
                    alert('Booking cancelled successfully.');
                    loadStudentSeatInfo();
                } catch (error) {
                    console.error('Error cancelling booking:', error);
                    alert('Error cancelling booking. Please try again.');
                }
            }
        }

        // Load student profile
        async function loadStudentProfile() {
            if (!currentUserData) return;

            // Update profile header
            document.getElementById('profile-avatar').textContent = currentUserData.name ? currentUserData.name.charAt(0).toUpperCase() : 'S';
            document.getElementById('profile-name').textContent = currentUserData.name || 'Student';
            document.getElementById('profile-id').textContent = `Student ID: ${currentUserData.studentId || 'N/A'}`;
            document.getElementById('profile-department').textContent = `Department: ${currentUserData.department || 'N/A'}`;

            // Update form fields
            document.getElementById('profile-fullname').value = currentUserData.name || '';
            document.getElementById('profile-studentid').value = currentUserData.studentId || '';
            document.getElementById('profile-email').value = currentUserData.email || '';
            document.getElementById('profile-department-input').value = currentUserData.department || '';
            document.getElementById('profile-batch').value = currentUserData.batch || '';
            document.getElementById('profile-phone').value = currentUserData.phone || '';

            // Load available routes
            const routesSnapshot = await db.collection('buses').get();
            const routeSelect = document.getElementById('profile-route');
            routeSelect.innerHTML = '<option value="">-- Select Route --</option>';

            routesSnapshot.forEach(doc => {
                const bus = doc.data();
                const option = document.createElement('option');
                option.value = bus.routeNo;
                option.textContent = `Route ${bus.routeNo} - ${bus.routeName}`;
                if (bus.routeNo === currentUserData.route) {
                    option.selected = true;
                }
                routeSelect.appendChild(option);
            });

            // Load bus and driver information if route is assigned
            if (currentUserData.route) {
                await loadBusAndDriverInfo(currentUserData.route);
            }
        }

        // Load bus and driver information for profile
        async function loadBusAndDriverInfo(routeNo) {
            try {
                const busDoc = await db.collection('buses').where('routeNo', '==', routeNo).get();
                if (!busDoc.empty) {
                    const busData = busDoc.docs[0].data();

                    // Update bus details
                    document.getElementById('profile-bus').value = `${busData.busNumber} - ${busData.routeName}`;

                    // Get driver info
                    if (busData.driverId) {
                        const driverDoc = await db.collection('drivers').doc(busData.driverId).get();
                        if (driverDoc.exists) {
                            const driver = driverDoc.data();
                            document.getElementById('profile-driver').value = driver.name;
                            document.getElementById('profile-driver-phone').value = driver.phone;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading bus and driver info:', error);
            }
        }

        // Update student profile
        document.getElementById('profile-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const updatedData = {
                name: document.getElementById('profile-fullname').value,
                department: document.getElementById('profile-department-input').value,
                batch: document.getElementById('profile-batch').value,
                phone: document.getElementById('profile-phone').value,
                route: document.getElementById('profile-route').value
            };

            try {
                await db.collection('users').doc(currentUser.uid).update(updatedData);
                currentUserData = { ...currentUserData, ...updatedData };
                alert('Profile updated successfully!');

                // Reload bus and driver info if route changed
                if (updatedData.route) {
                    await loadBusAndDriverInfo(updatedData.route);
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Error updating profile. Please try again.');
            }
        });

        // Logout function
        async function logout() {
            try {
                await auth.signOut();
                currentUser = null;
                currentUserData = null;
                studentPortal.classList.add('hidden');
                driverPortal.classList.add('hidden');
                adminPortal.classList.add('hidden');
                showMainPortal();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function () {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    try {
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            currentUser = user;
                            currentUserData = userDoc.data();

                            mainPortal.classList.add('hidden');
                            loginForms.classList.add('hidden');

                            if (currentUserData.type === 'student') {
                                studentPortal.classList.remove('hidden');
                                loadStudentData();
                                showStudentSection('dashboard');
                            } else if (currentUserData.type === 'driver') {
                                driverPortal.classList.remove('hidden');
                                loadDriverData();
                                showDriverSection('dashboard');
                            } else if (currentUserData.type === 'admin') {
                                adminPortal.classList.remove('hidden');
                                loadAdminData();
                                showAdminSection('dashboard');
                            }
                        } else {
                            console.log('User document not found in users collection, checking drivers collection...');
                            const driverDoc = await db.collection('drivers').doc(user.uid).get();
                            if (driverDoc.exists) {
                                const driverData = driverDoc.data();
                                await db.collection('users').doc(user.uid).set(driverData);
                                location.reload();
                            } else {
                                await auth.signOut();
                                alert('User data not found. Please contact administrator.');
                            }
                        }
                    } catch (error) {
                        console.error('Error in auth state change:', error);
                        showMainPortal();
                    }
                } else {
                    currentUser = null;
                    currentUserData = null;
                    showMainPortal();
                }
            });

            initializeSampleData();
        });

        // Make sure to update the driver section navigation to use the fixed function
        function showDriverSection(section) {
            // Hide all driver sections
            document.querySelectorAll('.driver-section').forEach(el => {
                el.classList.add('hidden');
            });

            // Show the selected section
            document.getElementById(`driver-${section}`).classList.remove('hidden');

            // Update active nav link
            document.querySelectorAll('#driver-portal nav a').forEach(link => {
                link.classList.remove('active');
            });

            // Find and activate the correct nav link
            const navLinks = document.querySelectorAll('#driver-portal nav a');
            for (let link of navLinks) {
                if (link.textContent.toLowerCase().includes(section)) {
                    link.classList.add('active');
                    break;
                }
            }

            // Load section-specific data
            if (section === 'location') {
                loadDriverLocationForm();
            } else if (section === 'notifications') {
                loadDriverNotifications(); // This is now fixed
            }
        }

        // Load driver data
        async function loadDriverData() {
            if (!currentUserData) return;

            // Update welcome message and avatar
            document.getElementById('driver-welcome').textContent = `Welcome, ${currentUserData.name || 'Driver'}!`;
            document.getElementById('driver-avatar').textContent = currentUserData.name ? currentUserData.name.charAt(0).toUpperCase() : 'D';
            document.getElementById('driver-id-display').textContent = `Driver ID: ${currentUserData.driverId || 'N/A'}`;

            // Load driver schedule and route info
            await loadDriverSchedule();
            await loadDriverRouteInfo();

            // Initialize map (simulated)
            document.getElementById('driver-map').innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background-color: #e9ecef; color: #6c757d;">
                    <div style="text-align: center;">
                        <div style="font-size: 3rem;">üìç</div>
                        <p>Live Location Sharing</p>
                        <p>Your current location is being shared with students</p>
                    </div>
                </div>
            `;
        }

        // Load driver schedule
        async function loadDriverSchedule() {
            if (!currentUserData.driverId) return;

            try {
                // Find bus assigned to this driver
                const busDoc = await db.collection('buses').where('driverId', '==', currentUser.uid).get();
                if (!busDoc.empty) {
                    const busData = busDoc.docs[0].data();

                    document.getElementById('driver-route-info').textContent = `Route ${busData.routeNo} - ${busData.routeName} | Bus: ${busData.busNumber}`;

                    const scheduleHTML = `
                        <p><strong>Route:</strong> ${busData.routeNo} - ${busData.routeName}</p>
                        <p><strong>Departure:</strong> ${busData.departureTime || 'N/A'}</p>
                        <p><strong>Estimated Arrival:</strong> ${busData.estimatedArrival || 'N/A'}</p>
                        <p><strong>Current Status:</strong> <span class="bus-status ${busData.status === 'Delayed' ? 'status-delayed' : 'status-ontime'}">${busData.status || 'N/A'}</span></p>
                        <p><strong>Passengers:</strong> ${busData.currentPassengers || 0}/${busData.capacity || 40}</p>
                    `;

                    document.getElementById('driver-schedule').innerHTML = scheduleHTML;
                } else {
                    document.getElementById('driver-schedule').innerHTML = '<p>No bus assigned</p>';
                }
            } catch (error) {
                console.error('Error loading driver schedule:', error);
                document.getElementById('driver-schedule').innerHTML = '<p>Error loading schedule</p>';
            }
        }

        // Load driver route info - FIXED VERSION
        async function loadDriverRouteInfo() {
            if (!currentUserData.driverId) return;

            try {
                const busDoc = await db.collection('buses').where('driverId', '==', currentUser.uid).get();
                if (!busDoc.empty) {
                    const busData = busDoc.docs[0].data();

                    // Fix stops display - properly extract stop names
                    let stopsText = 'N/A';
                    if (busData.stops && Array.isArray(busData.stops)) {
                        stopsText = busData.stops.map(stop => stop.name).join(', ');
                    }

                    const routeInfoHTML = `
                <p><strong>Stops:</strong> ${stopsText}</p>
                <p><strong>Distance:</strong> ${busData.distance || 'N/A'} km</p>
                <p><strong>Estimated Time:</strong> ${busData.estimatedTime || 'N/A'} min</p>
                <p><strong>Next Stop:</strong> ${busData.nextStop || 'N/A'}</p>
            `;

                    document.getElementById('driver-route-details').innerHTML = routeInfoHTML;
                } else {
                    document.getElementById('driver-route-details').innerHTML = '<p>No route information available</p>';
                }
            } catch (error) {
                console.error('Error loading route info:', error);
                document.getElementById('driver-route-details').innerHTML = '<p>Error loading route information</p>';
            }
        }

        // Load driver location form - FIXED VERSION
        async function loadDriverLocationForm() {
            if (!currentUserData.driverId) return;

            try {
                const busDoc = await db.collection('buses').where('driverId', '==', currentUser.uid).get();
                if (!busDoc.empty) {
                    const busData = busDoc.docs[0].data();

                    // Set current status
                    document.getElementById('bus-status').value = busData.status || 'On the way';

                    // Load stops for dropdown - FIXED
                    const stopSelect = document.getElementById('next-stop');
                    stopSelect.innerHTML = '';

                    if (busData.stops && Array.isArray(busData.stops)) {
                        busData.stops.forEach(stop => {
                            const option = document.createElement('option');
                            option.value = stop.name;
                            option.textContent = stop.name;
                            if (busData.nextStop === stop.name) {
                                option.selected = true;
                            }
                            stopSelect.appendChild(option);
                        });
                    } else {
                        // Fallback stops if no stops data
                        const fallbackStops = ['Mirpur 10', 'Mirpur 1', 'Kazipara', 'Shewrapara', 'Agargaon', 'SU Campus'];
                        fallbackStops.forEach(stop => {
                            const option = document.createElement('option');
                            option.value = stop;
                            option.textContent = stop;
                            if (busData.nextStop === stop) {
                                option.selected = true;
                            }
                            stopSelect.appendChild(option);
                        });
                    }

                    // Set ETA
                    document.getElementById('eta').value = busData.eta || 0;

                    // Set delay reason if exists
                    if (busData.delayReason) {
                        document.getElementById('delay-reason').value = busData.delayReason;
                    }
                }
            } catch (error) {
                console.error('Error loading location form:', error);
            }
        }

        // Update location - ENHANCED VERSION
        async function updateLocation() {
            if (!currentUserData.driverId) return;

            const status = document.getElementById('bus-status').value;
            const reason = document.getElementById('delay-reason').value;
            const nextStop = document.getElementById('next-stop').value;
            const eta = document.getElementById('eta').value;

            if (!nextStop) {
                alert('Please select a next stop');
                return;
            }

            try {
                const busDoc = await db.collection('buses').where('driverId', '==', currentUser.uid).get();
                if (!busDoc.empty) {
                    const busId = busDoc.docs[0].id;
                    const updateData = {
                        status: status,
                        nextStop: nextStop,
                        eta: parseInt(eta) || 0,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    if (status === 'Delayed' && reason) {
                        updateData.delayReason = reason;
                        updateData.delayMinutes = parseInt(eta) || 0;
                    } else {
                        // Clear delay reason if status is not delayed
                        updateData.delayReason = '';
                        updateData.delayMinutes = 0;
                    }

                    await db.collection('buses').doc(busId).update(updateData);

                    // Also send notification if status is Delayed or Breakdown
                    if (status === 'Delayed' || status === 'Breakdown') {
                        await sendStatusNotification(status, reason, nextStop, eta);
                    }

                    alert('Location and status updated successfully!');
                    showDriverSection('dashboard');
                }
            } catch (error) {
                console.error('Error updating location:', error);
                alert('Error updating location: ' + error.message);
            }
        }

        // Send status notification when driver updates status
        async function sendStatusNotification(status, reason, nextStop, eta) {
            try {
                const busDoc = await db.collection('buses').where('driverId', '==', currentUser.uid).get();
                if (!busDoc.empty) {
                    const busData = busDoc.docs[0].data();
                    const routeNo = busData.routeNo;

                    let title = '';
                    let message = '';

                    if (status === 'Delayed') {
                        title = `Route ${routeNo} Delay Alert`;
                        message = `Bus on Route ${routeNo} is delayed. ${reason ? 'Reason: ' + reason + '. ' : ''}ETA to ${nextStop}: ${eta} minutes.`;
                    } else if (status === 'Breakdown') {
                        title = `Route ${routeNo} Service Interruption`;
                        message = `Bus on Route ${routeNo} has experienced a breakdown. ${reason ? 'Details: ' + reason + '. ' : ''}Service will resume shortly.`;
                    }

                    if (title && message) {
                        await db.collection('notifications').add({
                            title: title,
                            message: message,
                            type: status,
                            audience: [routeNo, 'admin'], // Send to route students and admin
                            sender: currentUserData.name,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }
            } catch (error) {
                console.error('Error sending status notification:', error);
            }
        }

        // Also fix the driver schedule display
        async function loadDriverSchedule() {
            if (!currentUserData.driverId) return;

            try {
                // Find bus assigned to this driver
                const busDoc = await db.collection('buses').where('driverId', '==', currentUser.uid).get();
                if (!busDoc.empty) {
                    const busData = busDoc.docs[0].data();

                    document.getElementById('driver-route-info').textContent = `Route ${busData.routeNo} - ${busData.routeName} | Bus: ${busData.busNumber}`;

                    // Fix stops display in schedule
                    let stopsText = 'N/A';
                    if (busData.stops && Array.isArray(busData.stops)) {
                        stopsText = busData.stops.map(stop => stop.name).join(' ‚Üí ');
                    }

                    const scheduleHTML = `
                <p><strong>Route:</strong> ${busData.routeNo} - ${busData.routeName}</p>
                <p><strong>Stops:</strong> ${stopsText}</p>
                <p><strong>Departure to Campus:</strong> ${busData.departureTime || 'N/A'}</p>
                <p><strong>Departure from Campus:</strong> ${busData.departureTimeFromCampus || 'N/A'}</p>
                <p><strong>Current Status:</strong> <span class="bus-status ${busData.status === 'Delayed' ? 'status-delayed' : 'status-ontime'}">${busData.status || 'N/A'}</span></p>
                <p><strong>Next Stop:</strong> ${busData.nextStop || 'N/A'}</p>
                <p><strong>ETA to Next Stop:</strong> ${busData.eta || 0} min</p>
            `;

                    document.getElementById('driver-schedule').innerHTML = scheduleHTML;
                } else {
                    document.getElementById('driver-schedule').innerHTML = '<p>No bus assigned</p>';
                }
            } catch (error) {
                console.error('Error loading driver schedule:', error);
                document.getElementById('driver-schedule').innerHTML = '<p>Error loading schedule</p>';
            }
        }

        // Update bus status
        async function updateBusStatus(status) {
            if (!currentUserData.driverId) return;

            try {
                const busDoc = await db.collection('buses').where('driverId', '==', currentUser.uid).get();
                if (!busDoc.empty) {
                    const busId = busDoc.docs[0].id;
                    await db.collection('buses').doc(busId).update({
                        status: status,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    alert(`Bus status updated to: ${status}`);
                    loadDriverSchedule();
                }
            } catch (error) {
                console.error('Error updating bus status:', error);
                alert('Error updating status: ' + error.message);
            }
        }

        // Update location
        async function updateLocation() {
            if (!currentUserData.driverId) return;

            const status = document.getElementById('bus-status').value;
            const reason = document.getElementById('delay-reason').value;
            const nextStop = document.getElementById('next-stop').value;
            const eta = document.getElementById('eta').value;

            try {
                const busDoc = await db.collection('buses').where('driverId', '==', currentUser.uid).get();
                if (!busDoc.empty) {
                    const busId = busDoc.docs[0].id;
                    const updateData = {
                        status: status,
                        nextStop: nextStop,
                        eta: parseInt(eta),
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    if (status === 'Delayed' && reason) {
                        updateData.delayReason = reason;
                        updateData.delayMinutes = parseInt(eta);
                    }

                    await db.collection('buses').doc(busId).update(updateData);

                    alert('Location and status updated successfully!');
                    showDriverSection('dashboard');
                }
            } catch (error) {
                console.error('Error updating location:', error);
                alert('Error updating location: ' + error.message);
            }
        }

        // Send notification (driver)
        async function sendNotification() {
            const type = document.getElementById('notification-type').value;
            const title = document.getElementById('notification-title').value;
            const message = document.getElementById('notification-message').value;
            const audience = document.getElementById('notification-audience').value;

            if (!title || !message) {
                alert('Please fill in all fields');
                return;
            }

            try {
                // Get driver's route
                const busDoc = await db.collection('buses').where('driverId', '==', currentUser.uid).get();
                if (busDoc.empty) {
                    alert('No bus assigned to you');
                    return;
                }

                const busData = busDoc.docs[0].data();
                const routeNo = busData.routeNo;

                let targetAudience = [];
                if (audience === 'all') {
                    targetAudience = ['all'];
                } else if (audience === 'route') {
                    targetAudience = [routeNo];
                } else if (audience === 'admin') {
                    targetAudience = ['admin'];
                }

                await db.collection('notifications').add({
                    title: title,
                    message: message,
                    type: type,
                    audience: targetAudience,
                    sender: currentUserData.name,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Notification sent successfully!');

                // Clear form
                document.getElementById('notification-title').value = '';
                document.getElementById('notification-message').value = '';
            } catch (error) {
                console.error('Error sending notification:', error);
                alert('Error sending notification: ' + error.message);
            }
        }

        // FIXED: Load driver notifications - COMPLETELY REWRITTEN
        async function loadDriverNotifications() {
            try {
                console.log('Loading driver notifications...');

                // Get driver's route information first
                const busDoc = await db.collection('buses').where('driverId', '==', currentUser.uid).get();

                if (busDoc.empty) {
                    document.getElementById('driver-notification-list').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üöå</div>
                            <p>No bus assigned to you</p>
                            <p>You need to be assigned to a bus to receive notifications</p>
                        </div>
                    `;
                    return;
                }

                const busData = busDoc.docs[0].data();
                const routeNo = busData.routeNo;

                console.log('Driver route:', routeNo);

                // Get ALL notifications and filter client-side to avoid index issues
                const allNotificationsSnapshot = await db.collection('notifications')
                    .orderBy('timestamp', 'desc')
                    .limit(50) // Get more notifications to filter client-side
                    .get();

                const allNotifications = [];

                // Filter notifications client-side
                allNotificationsSnapshot.forEach(doc => {
                    const notification = { ...doc.data(), id: doc.id };

                    // Determine notification source
                    if (notification.audience) {
                        // Notifications for driver's route
                        if (notification.audience.includes(routeNo)) {
                            notification.source = 'route';
                            allNotifications.push(notification);
                        }
                        // General notifications for all
                        else if (notification.audience.includes('all')) {
                            notification.source = 'general';
                            allNotifications.push(notification);
                        }
                        // Notifications for drivers
                        else if (notification.audience.includes('drivers')) {
                            notification.source = 'drivers';
                            allNotifications.push(notification);
                        }
                        // Notifications sent by this driver
                        else if (notification.sender === currentUserData.name) {
                            notification.source = 'sent';
                            allNotifications.push(notification);
                        }
                    }
                });

                // Sort by timestamp (newest first)
                allNotifications.sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.toDate() : new Date(0);
                    const timeB = b.timestamp ? b.timestamp.toDate() : new Date(0);
                    return timeB - timeA;
                });

                let notificationsHTML = '';

                if (allNotifications.length === 0) {
                    notificationsHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>No notifications yet</p>
                            <p>Notifications from your route and system will appear here</p>
                        </div>
                    `;
                } else {
                    allNotifications.forEach(notification => {
                        const timestamp = notification.timestamp ?
                            new Date(notification.timestamp.toDate()).toLocaleString() : 'Unknown time';

                        // Determine notification type class
                        let typeClass = '';
                        let typeText = notification.type || 'General';

                        if (notification.type === 'Emergency') {
                            typeClass = 'emergency';
                        } else if (notification.type === 'Delay' || notification.type === 'Route Change') {
                            typeClass = 'warning';
                        } else if (notification.type === 'General') {
                            typeClass = 'success';
                        }

                        // Determine source badge
                        let sourceBadge = '';
                        let sourceText = '';

                        if (notification.source === 'sent') {
                            sourceBadge = '<span style="background: #3498db; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem;">Sent</span>';
                            sourceText = 'To: ' + (notification.audience ? notification.audience.join(', ') : 'All');
                        } else if (notification.source === 'route') {
                            sourceBadge = '<span style="background: #2ecc71; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem;">Route</span>';
                            sourceText = 'From: ' + (notification.sender || 'System');
                        } else if (notification.source === 'general') {
                            sourceBadge = '<span style="background: #9b59b6; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem;">General</span>';
                            sourceText = 'From: ' + (notification.sender || 'System');
                        } else if (notification.source === 'drivers') {
                            sourceBadge = '<span style="background: #e67e22; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem;">Drivers</span>';
                            sourceText = 'From: ' + (notification.sender || 'System');
                        }

                        notificationsHTML += `
                            <div class="notification-item ${typeClass}">
                                <div class="notification-header">
                                    <div class="notification-title">${notification.title}</div>
                                    <div>
                                        ${sourceBadge}
                                        <span class="notification-type">${typeText}</span>
                                    </div>
                                </div>
                                <div class="notification-message">${notification.message}</div>
                                <div class="notification-meta">
                                    <span>${sourceText}</span>
                                    <span>${timestamp}</span>
                                </div>
                            </div>
                        `;
                    });
                }

                document.getElementById('driver-notification-list').innerHTML = notificationsHTML;

            } catch (error) {
                console.error('Error loading driver notifications:', error);
                document.getElementById('driver-notification-list').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <p>Error loading notifications</p>
                        <p>Please try refreshing the page</p>
                        <button class="btn mt-20" onclick="loadDriverNotifications()">Try Again</button>
                    </div>
                `;
            }
        }

        // FIXED: Mark notifications as read function
        async function markNotificationsAsRead() {
            try {
                // Reset notification badge
                unreadNotificationsCount = 0;
                const notificationBadge = document.getElementById('notification-badge');
                if (notificationBadge) {
                    notificationBadge.classList.add('hidden');
                    notificationBadge.textContent = '0';
                }

                console.log('Notifications marked as read');
            } catch (error) {
                console.error('Error marking notifications as read:', error);
            }
        }

        // FIXED: Mark all notifications as read
        async function markAllNotificationsAsRead() {
            try {
                // Reset notification badge
                unreadNotificationsCount = 0;
                const notificationBadge = document.getElementById('notification-badge');
                if (notificationBadge) {
                    notificationBadge.classList.add('hidden');
                    notificationBadge.textContent = '0';
                }

                alert('All notifications marked as read');
                console.log('All notifications marked as read');
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
            }
        }

        // NEW: Load passenger count by stop for driver
        async function loadPassengerCountByStop() {
            if (!currentUserData.driverId) return;

            try {
                const busDoc = await db.collection('buses').where('driverId', '==', currentUser.uid).get();
                if (busDoc.empty) {
                    document.getElementById('passenger-count-container').classList.add('hidden');
                    return;
                }

                const busData = busDoc.docs[0].data();
                const routeNo = busData.routeNo;
                const today = new Date().toISOString().split('T')[0];

                // Get bookings for today for both directions
                const toCampusBookings = await db.collection('bookings')
                    .where('routeNo', '==', routeNo)
                    .where('date', '==', today)
                    .where('direction', '==', 'to-campus')
                    .get();

                const fromCampusBookings = await db.collection('bookings')
                    .where('routeNo', '==', routeNo)
                    .where('date', '==', today)
                    .where('direction', '==', 'from-campus')
                    .get();

                // Count passengers by stop for each direction
                const stopCounts = {};

                // Process to-campus bookings
                toCampusBookings.forEach(doc => {
                    const booking = doc.data();
                    const stop = booking.stop;
                    if (stop) {
                        if (!stopCounts[stop]) {
                            stopCounts[stop] = { toCampus: 0, fromCampus: 0 };
                        }
                        stopCounts[stop].toCampus++;
                    }
                });

                // Process from-campus bookings
                fromCampusBookings.forEach(doc => {
                    const booking = doc.data();
                    const stop = booking.stop;
                    if (stop) {
                        if (!stopCounts[stop]) {
                            stopCounts[stop] = { toCampus: 0, fromCampus: 0 };
                        }
                        stopCounts[stop].fromCampus++;
                    }
                });

                let passengerHTML = '';

                if (Object.keys(stopCounts).length === 0) {
                    passengerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üë•</div>
                            <p>No passengers booked for today</p>
                        </div>
                    `;
                } else {
                    for (const [stopName, counts] of Object.entries(stopCounts)) {
                        passengerHTML += `
                            <div class="passenger-stop-item">
                                <div class="stop-name">${stopName}</div>
                                <div class="passenger-count">${counts.toCampus + counts.fromCampus}</div>
                                <div class="direction-label">
                                    To Campus: ${counts.toCampus} | From Campus: ${counts.fromCampus}
                                </div>
                            </div>
                        `;
                    }
                }

                document.getElementById('passenger-count-grid').innerHTML = passengerHTML;
                document.getElementById('passenger-count-container').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading passenger count:', error);
                document.getElementById('passenger-count-container').classList.add('hidden');
            }
        }

        // Update driver data to include passenger count
        async function loadDriverData() {
            if (!currentUserData) return;

            // Update welcome message and avatar
            document.getElementById('driver-welcome').textContent = `Welcome, ${currentUserData.name || 'Driver'}!`;
            document.getElementById('driver-avatar').textContent = currentUserData.name ? currentUserData.name.charAt(0).toUpperCase() : 'D';
            document.getElementById('driver-id-display').textContent = `Driver ID: ${currentUserData.driverId || 'N/A'}`;

            // Load driver schedule and route info
            await loadDriverSchedule();
            await loadDriverRouteInfo();

            // NEW: Load passenger count by stop
            await loadPassengerCountByStop();

            // Initialize map (simulated)
            document.getElementById('driver-map').innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background-color: #e9ecef; color: #6c757d;">
                    <div style="text-align: center;">
                        <div style="font-size: 3rem;">üìç</div>
                        <p>Live Location Sharing</p>
                        <p>Your current location is being shared with students</p>
                    </div>
                </div>
            `;
        }

        // Update driver schedule to refresh passenger count when status changes
        async function updateBusStatus(status) {
            if (!currentUserData.driverId) return;

            try {
                const busDoc = await db.collection('buses').where('driverId', '==', currentUser.uid).get();
                if (!busDoc.empty) {
                    const busId = busDoc.docs[0].id;
                    await db.collection('buses').doc(busId).update({
                        status: status,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    alert(`Bus status updated to: ${status}`);
                    loadDriverSchedule();

                    // Refresh passenger count
                    await loadPassengerCountByStop();
                }
            } catch (error) {
                console.error('Error updating bus status:', error);
                alert('Error updating status: ' + error.message);
            }
        }

        // Update the driver section navigation to load notifications properly
        function showDriverSection(section) {
            // Hide all driver sections
            document.querySelectorAll('.driver-section').forEach(el => {
                el.classList.add('hidden');
            });

            // Show the selected section
            document.getElementById(`driver-${section}`).classList.remove('hidden');

            // Update active nav link
            document.querySelectorAll('#driver-portal nav a').forEach(link => {
                link.classList.remove('active');
            });

            // Find and activate the correct nav link
            const navLinks = document.querySelectorAll('#driver-portal nav a');
            for (let link of navLinks) {
                if (link.textContent.toLowerCase().includes(section)) {
                    link.classList.add('active');
                    break;
                }
            }

            // Load section-specific data
            if (section === 'location') {
                loadDriverLocationForm();
            } else if (section === 'notifications') {
                loadDriverNotifications(); // This will now load both sent and received notifications
            }
        }

        // Admin section navigation
        function showAdminSection(section) {
            // Hide all admin sections
            document.querySelectorAll('.admin-section').forEach(el => {
                el.classList.add('hidden');
            });

            // Show the selected section
            document.getElementById(`admin-${section}`).classList.remove('hidden');

            // Update active nav link
            document.querySelectorAll('#admin-portal nav a').forEach(link => {
                link.classList.remove('active');
            });

            // Find and activate the correct nav link
            const navLinks = document.querySelectorAll('#admin-portal nav a');
            for (let link of navLinks) {
                if (link.textContent.toLowerCase().includes(section)) {
                    link.classList.add('active');
                    break;
                }
            }

            // Load section-specific data
            if (section === 'buses') {
                loadAdminBuses();
            } else if (section === 'drivers') {
                loadAdminDrivers();
            } else if (section === 'students') {
                loadAdminStudents();
            } else if (section === 'tracking') {
                loadAdminTracking();
            } else if (section === 'notifications') {
                loadAdminNotifications();
            }
            if (section === 'reports') {
                loadReportForm();
            }
        }

        // Load admin data
        async function loadAdminData() {
            await loadAdminSystemStats();
            await loadAdminAlerts();
            await loadAdminBusStatus();
        }

        // Load admin system stats
        async function loadAdminSystemStats() {
            try {
                // Get counts from Firestore
                const busesCount = (await db.collection('buses').get()).size;
                const driversCount = (await db.collection('drivers').get()).size;
                const studentsCount = (await db.collection('users').where('type', '==', 'student').get()).size;

                // Get today's passenger count by direction
                const today = new Date().toISOString().split('T')[0];
                const toCampusBookings = await db.collection('bookings')
                    .where('date', '==', today)
                    .where('direction', '==', 'to-campus')
                    .get();

                const fromCampusBookings = await db.collection('bookings')
                    .where('date', '==', today)
                    .where('direction', '==', 'from-campus')
                    .get();

                const toCampusCount = toCampusBookings.size;
                const fromCampusCount = fromCampusBookings.size;
                const totalBookingsCount = toCampusCount + fromCampusCount;

                const statsHTML = `
                    <p><strong>Total Buses:</strong> ${busesCount}</p>
                    <p><strong>Active Routes:</strong> ${busesCount}</p>
                    <p><strong>Registered Students:</strong> ${studentsCount}</p>
                    <p><strong>Active Drivers:</strong> ${driversCount}</p>
                    <p><strong>Today's Passengers:</strong> ${totalBookingsCount}</p>
                    <div class="passenger-stats">
                        <div class="passenger-direction">
                            <div>To Campus</div>
                            <div class="passenger-count">${toCampusCount}</div>
                        </div>
                        <div class="passenger-direction">
                            <div>From Campus</div>
                            <div class="passenger-count">${fromCampusCount}</div>
                        </div>
                    </div>
                `;

                document.getElementById('admin-system-stats').innerHTML = statsHTML;
            } catch (error) {
                console.error('Error loading system stats:', error);
                document.getElementById('admin-system-stats').innerHTML = '<p>Error loading system statistics</p>';
            }
        }

        // Load admin alerts - FIXED VERSION
        async function loadAdminAlerts() {
            try {
                const now = new Date();
                const twentyFourHoursAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000));

                // Get recent notifications
                const notificationsSnapshot = await db.collection('notifications')
                    .where('timestamp', '>', twentyFourHoursAgo)
                    .orderBy('timestamp', 'desc')
                    .limit(10)
                    .get();

                // Get delayed buses
                const delayedBusesSnapshot = await db.collection('buses')
                    .where('status', '==', 'Delayed')
                    .get();

                // Get buses needing maintenance
                const maintenanceBusesSnapshot = await db.collection('buses')
                    .where('status', '==', 'Maintenance')
                    .get();

                // Get buses with breakdowns
                const breakdownBusesSnapshot = await db.collection('buses')
                    .where('status', '==', 'Breakdown')
                    .get();

                let alertsHTML = '';

                // Check for different types of alerts
                const alerts = [];

                // Delayed buses alert
                if (!delayedBusesSnapshot.empty) {
                    alerts.push({
                        type: 'warning',
                        message: `${delayedBusesSnapshot.size} bus(es) are currently delayed`,
                        icon: '‚è∞'
                    });
                }

                // Maintenance needed alert
                if (!maintenanceBusesSnapshot.empty) {
                    alerts.push({
                        type: 'warning',
                        message: `${maintenanceBusesSnapshot.size} bus(es) require maintenance`,
                        icon: 'üîß'
                    });
                }

                // Breakdown alert
                if (!breakdownBusesSnapshot.empty) {
                    alerts.push({
                        type: 'error',
                        message: `${breakdownBusesSnapshot.size} bus(es) have breakdowns`,
                        icon: 'üö®'
                    });
                }

                // Recent important notifications
                if (!notificationsSnapshot.empty) {
                    const emergencyNotifications = notificationsSnapshot.docs.filter(doc =>
                        doc.data().type === 'Emergency' || doc.data().type === 'Breakdown'
                    );

                    if (emergencyNotifications.length > 0) {
                        alerts.push({
                            type: 'error',
                            message: `${emergencyNotifications.length} emergency notification(s) in last 24 hours`,
                            icon: 'üì¢'
                        });
                    }
                }

                // Check for buses without drivers
                const busesSnapshot = await db.collection('buses').get();
                let busesWithoutDrivers = 0;

                for (const doc of busesSnapshot.docs) {
                    const bus = doc.data();
                    if (!bus.driverId) {
                        busesWithoutDrivers++;
                    }
                }

                if (busesWithoutDrivers > 0) {
                    alerts.push({
                        type: 'warning',
                        message: `${busesWithoutDrivers} bus(es) without assigned drivers`,
                        icon: 'üë§'
                    });
                }

                // Display alerts
                if (alerts.length === 0) {
                    alertsHTML = `
                <div class="notification success">
                    <strong>‚úÖ All Systems Operational</strong>
                    <p>No critical alerts at this time</p>
                </div>
            `;
                } else {
                    alerts.forEach(alert => {
                        const alertClass = alert.type === 'error' ? 'error' : 'warning';
                        alertsHTML += `
                    <div class="notification ${alertClass}">
                        <strong>${alert.icon} ${alert.message}</strong>
                        <p>Click to view details</p>
                    </div>
                `;
                    });
                }

                // Add system statistics
                alertsHTML += `
            <div class="system-stats-overview mt-20">
                <h4>Quick Stats</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${busesSnapshot.size}</div>
                        <div class="stat-label">Total Buses</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${delayedBusesSnapshot.size}</div>
                        <div class="stat-label">Delayed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${maintenanceBusesSnapshot.size + breakdownBusesSnapshot.size}</div>
                        <div class="stat-label">Issues</div>
                    </div>
                </div>
            </div>
        `;

                document.getElementById('admin-alerts').innerHTML = alertsHTML;

            } catch (error) {
                console.error('Error loading alerts:', error);
                document.getElementById('admin-alerts').innerHTML = `
            <div class="notification error">
                <strong>Error Loading Alerts</strong>
                <p>Please refresh the page</p>
            </div>
        `;
            }
        }

        // Load admin bus status overview - FIXED VERSION
        async function loadAdminBusStatus() {
            try {
                const busesSnapshot = await db.collection('buses').get();
                let statusHTML = '';

                if (busesSnapshot.empty) {
                    statusHTML = '<p>No buses found in the system</p>';
                } else {
                    statusHTML = `
                <div class="bus-status-overview">
                    <div class="status-grid">
            `;

                    const statusCounts = {
                        'Active': 0,
                        'Inactive': 0,
                        'Maintenance': 0,
                        'On the way': 0,
                        'Delayed': 0,
                        'Arrived': 0,
                        'Breakdown': 0
                    };

                    busesSnapshot.forEach(doc => {
                        const bus = doc.data();
                        const status = bus.status || 'Active';
                        statusCounts[status] = (statusCounts[status] || 0) + 1;
                    });

                    // Display status counts with proper styling
                    for (const [status, count] of Object.entries(statusCounts)) {
                        if (count > 0) {
                            let statusClass = 'status-ontime';
                            if (status === 'Inactive' || status === 'Delayed' || status === 'Breakdown') {
                                statusClass = 'status-delayed';
                            } else if (status === 'Maintenance') {
                                statusClass = 'status-arrived';
                            }

                            statusHTML += `
                        <div class="status-item">
                            <span class="bus-status ${statusClass}">${status}</span>
                            <span class="status-count">${count} buses</span>
                        </div>
                    `;
                        }
                    }

                    statusHTML += `
                    </div>
                </div>
            `;

                    // Add detailed bus list
                    statusHTML += `
                <div class="detailed-bus-list mt-20">
                    <h4>Detailed Bus Status</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Route</th>
                                <th>Bus Number</th>
                                <th>Driver</th>
                                <th>Status</th>
                                <th>Last Update</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

                    for (const doc of busesSnapshot.docs) {
                        const bus = doc.data();

                        // Get driver info
                        let driverName = 'N/A';
                        if (bus.driverId) {
                            const driverDoc = await db.collection('drivers').doc(bus.driverId).get();
                            if (driverDoc.exists) {
                                driverName = driverDoc.data().name;
                            }
                        }

                        let statusClass = 'status-ontime';
                        if (bus.status === 'Inactive' || bus.status === 'Delayed' || bus.status === 'Breakdown') {
                            statusClass = 'status-delayed';
                        } else if (bus.status === 'Maintenance') {
                            statusClass = 'status-arrived';
                        }

                        const lastUpdate = bus.timestamp ?
                            new Date(bus.timestamp.toDate()).toLocaleString() : 'Never';

                        statusHTML += `
                    <tr>
                        <td>${bus.routeNo} - ${bus.routeName}</td>
                        <td>${bus.busNumber}</td>
                        <td>${driverName}</td>
                        <td><span class="bus-status ${statusClass}">${bus.status || 'Active'}</span></td>
                        <td>${lastUpdate}</td>
                    </tr>
                `;
                    }

                    statusHTML += `
                        </tbody>
                    </table>
                </div>
            `;
                }

                document.getElementById('admin-bus-status').innerHTML = statusHTML;
            } catch (error) {
                console.error('Error loading bus status:', error);
                document.getElementById('admin-bus-status').innerHTML = '<p>Error loading bus status information</p>';
            }
        }

        // Load admin buse - UPDATED WITH STATUS FUNCTIONALITY
        async function loadAdminBuses() {
            try {
                const busesSnapshot = await db.collection('buses').get();
                const driversSnapshot = await db.collection('drivers').get();

                // Populate driver dropdown
                const driverSelect = document.getElementById('bus-driver');
                driverSelect.innerHTML = '<option value="">-- Select Driver --</option>';

                driversSnapshot.forEach(doc => {
                    const driver = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = driver.name;
                    driverSelect.appendChild(option);
                });

                let tableHTML = `
                    <table class="table" id="buses-table">
                        <thead>
                            <tr>
                                <th>Route No</th>
                                <th>Route Name</th>
                                <th>Bus Number</th>
                                <th>Driver</th>
                                <th>Capacity</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                for (const doc of busesSnapshot.docs) {
                    const bus = doc.data();

                    // Get driver info
                    let driverName = 'N/A';
                    if (bus.driverId) {
                        const driverDoc = await db.collection('drivers').doc(bus.driverId).get();
                        if (driverDoc.exists) {
                            driverName = driverDoc.data().name;
                        }
                    }

                    // Determine status class
                    let statusClass = 'status-ontime';
                    if (bus.status === 'Inactive') {
                        statusClass = 'status-delayed';
                    } else if (bus.status === 'Maintenance') {
                        statusClass = 'status-arrived';
                    }

                    tableHTML += `
                        <tr>
                            <td>${bus.routeNo}</td>
                            <td>${bus.routeName}</td>
                            <td>${bus.busNumber}</td>
                            <td>${driverName}</td>
                            <td>${bus.capacity || 40}</td>
                            <td><span class="bus-status ${statusClass}">${bus.status || 'Active'}</span></td>
                            <td>
                                <button class="btn" onclick="editBus('${doc.id}')">Edit</button>
                                <button class="btn btn-danger" onclick="deleteBus('${doc.id}')">Delete</button>
                            </td>
                        </tr>
                    `;
                }

                tableHTML += '</tbody></table>';
                document.getElementById('admin-bus-table').innerHTML = tableHTML;
            } catch (error) {
                console.error('Error loading buses:', error);
                document.getElementById('admin-bus-table').innerHTML = '<p>Error loading bus information</p>';
            }
        }

        // Search buses function
        function searchBuses() {
            const input = document.getElementById('bus-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('buses-table');
            const tr = table.getElementsByTagName('tr');

            // Loop through all table rows, and hide those that don't match the search query
            for (let i = 1; i < tr.length; i++) {
                let td = tr[i].getElementsByTagName('td');
                let found = false;

                for (let j = 0; j < td.length; j++) {
                    if (td[j]) {
                        const txtValue = td[j].textContent || td[j].innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            found = true;
                            break;
                        }
                    }
                }

                if (found) {
                    tr[i].style.display = '';
                } else {
                    tr[i].style.display = 'none';
                }
            }
        }

        // Show add bus form
        function showAddBusForm() {
            document.getElementById('bus-form-title').textContent = 'Add New Bus';
            document.getElementById('bus-form').reset();
            document.getElementById('bus-id').value = '';
            document.getElementById('bus-form-container').classList.remove('hidden');
        }

        // Edit bus
        async function editBus(busId) {
            try {
                const busDoc = await db.collection('buses').doc(busId).get();
                if (busDoc.exists) {
                    const bus = busDoc.data();

                    document.getElementById('bus-form-title').textContent = 'Edit Bus';
                    document.getElementById('bus-id').value = busId;
                    document.getElementById('bus-route-no').value = bus.routeNo || '';
                    document.getElementById('bus-route-name').value = bus.routeName || '';
                    document.getElementById('bus-number').value = bus.busNumber || '';
                    document.getElementById('bus-driver').value = bus.driverId || '';
                    document.getElementById('bus-capacity').value = bus.capacity || 40;
                    document.getElementById('bus-departure').value = bus.departureTime || '';

                    document.getElementById('bus-form-container').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading bus for edit:', error);
                alert('Error loading bus information');
            }
        }

        // Hide bus form
        function hideBusForm() {
            document.getElementById('bus-form-container').classList.add('hidden');
        }

        // Enhanced bus form functions
        function addStop() {
            const stopsContainer = document.getElementById('stops-container');
            const stopItem = document.createElement('div');
            stopItem.className = 'stop-item';
            stopItem.innerHTML = `
                <input type="text" class="stop-name" placeholder="Stop name" required>
                <input type="time" class="stop-time" required>
                <button type="button" class="remove-stop" onclick="removeStop(this)">Remove</button>
            `;
            stopsContainer.appendChild(stopItem);
        }

        function removeStop(button) {
            const stopsContainer = document.getElementById('stops-container');
            if (stopsContainer.children.length > 1) {
                button.parentElement.remove();
            } else {
                alert('At least one stop is required');
            }
        }

        // Bus Management - Enhanced with departureTimeFromCampus and separate stop times

        // Show add bus form - UPDATED WITH CAMPUS DEPARTURE TIME
        function showAddBusForm() {
            document.getElementById('bus-form-title').textContent = 'Add New Bus';
            document.getElementById('bus-form').reset();
            document.getElementById('bus-id').value = '';

            // Reset stops to one empty stop
            const stopsContainer = document.getElementById('stops-container');
            stopsContainer.innerHTML = `
        <div class="stop-item">
            <input type="text" class="stop-name" placeholder="Stop name" required>
            <input type="time" class="stop-time" placeholder="To Campus Time" required>
            <input type="time" class="stop-time-from-campus" placeholder="From Campus Time" required>
            <button type="button" class="remove-stop" onclick="removeStop(this)">Remove</button>
        </div>
    `;

            document.getElementById('bus-form-container').classList.remove('hidden');
        }

        // Edit bus - UPDATED WITH CAMPUS DEPARTURE TIME
        async function editBus(busId) {
            try {
                const busDoc = await db.collection('buses').doc(busId).get();
                if (busDoc.exists) {
                    const bus = busDoc.data();

                    document.getElementById('bus-form-title').textContent = 'Edit Bus';
                    document.getElementById('bus-id').value = busId;
                    document.getElementById('bus-route-no').value = bus.routeNo || '';
                    document.getElementById('bus-route-name').value = bus.routeName || '';
                    document.getElementById('bus-number').value = bus.busNumber || '';
                    document.getElementById('bus-driver').value = bus.driverId || '';
                    document.getElementById('bus-capacity').value = bus.capacity || 40;
                    document.getElementById('bus-status').value = bus.status || 'Active';
                    document.getElementById('bus-departure').value = bus.departureTime || '';
                    document.getElementById('bus-departure-from-campus').value = bus.departureTimeFromCampus || '';
                    document.getElementById('bus-distance').value = bus.distance || '';
                    document.getElementById('bus-estimated-time').value = bus.estimatedTime || '';
                    document.getElementById('bus-estimated-arrival').value = bus.estimatedArrival || '';

                    // Load stops
                    const stopsContainer = document.getElementById('stops-container');
                    stopsContainer.innerHTML = '';

                    if (bus.stops && bus.stops.length > 0) {
                        bus.stops.forEach(stop => {
                            const stopItem = document.createElement('div');
                            stopItem.className = 'stop-item';
                            stopItem.innerHTML = `
                        <input type="text" class="stop-name" value="${stop.name || ''}" placeholder="Stop name" required>
                        <input type="time" class="stop-time" value="${stop.time || ''}" placeholder="To Campus Time" required>
                        <input type="time" class="stop-time-from-campus" value="${stop.timeFromCampus || ''}" placeholder="From Campus Time" required>
                        <button type="button" class="remove-stop" onclick="removeStop(this)">Remove</button>
                    `;
                            stopsContainer.appendChild(stopItem);
                        });
                    } else {
                        // Add one empty stop if no stops exist
                        addStop();
                    }

                    document.getElementById('bus-form-container').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading bus for edit:', error);
                alert('Error loading bus information');
            }
        }

        // Enhanced bus form functions - UPDATED WITH CAMPUS DEPARTURE TIME
        function addStop() {
            const stopsContainer = document.getElementById('stops-container');
            const stopItem = document.createElement('div');
            stopItem.className = 'stop-item';
            stopItem.innerHTML = `
        <input type="text" class="stop-name" placeholder="Stop name" required>
        <input type="time" class="stop-time" placeholder="To Campus Time" required>
        <input type="time" class="stop-time-from-campus" placeholder="From Campus Time" required>
        <button type="button" class="remove-stop" onclick="removeStop(this)">Remove</button>
    `;
            stopsContainer.appendChild(stopItem);
        }

        // Save bus (add or edit) - ENHANCED VERSION WITH CAMPUS DEPARTURE TIME
        document.getElementById('bus-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            // Collect stops data
            const stopItems = document.querySelectorAll('.stop-item');
            const stops = [];

            for (let item of stopItems) {
                const name = item.querySelector('.stop-name').value;
                const time = item.querySelector('.stop-time').value;
                const timeFromCampus = item.querySelector('.stop-time-from-campus').value;

                if (name && time && timeFromCampus) {
                    stops.push({
                        name: name,
                        time: time,
                        timeFromCampus: timeFromCampus
                    });
                }
            }

            if (stops.length === 0) {
                alert('Please add at least one bus stop');
                return;
            }

            const busId = document.getElementById('bus-id').value;
            const busData = {
                routeNo: document.getElementById('bus-route-no').value,
                routeName: document.getElementById('bus-route-name').value,
                busNumber: document.getElementById('bus-number').value,
                driverId: document.getElementById('bus-driver').value,
                capacity: parseInt(document.getElementById('bus-capacity').value),
                status: document.getElementById('bus-status').value,
                departureTime: document.getElementById('bus-departure').value,
                departureTimeFromCampus: document.getElementById('bus-departure-from-campus').value,
                distance: parseFloat(document.getElementById('bus-distance').value),
                estimatedTime: parseInt(document.getElementById('bus-estimated-time').value),
                estimatedArrival: document.getElementById('bus-estimated-arrival').value,
                stops: stops,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (busId) {
                    // Update existing bus
                    await db.collection('buses').doc(busId).update(busData);
                    alert('Bus updated successfully!');
                } else {
                    // Add new bus
                    await db.collection('buses').add(busData);
                    alert('Bus added successfully!');
                }

                hideBusForm();
                loadAdminBuses();
            } catch (error) {
                console.error('Error saving bus:', error);
                alert('Error saving bus: ' + error.message);
            }
        });

        // Delete bus
        async function deleteBus(busId) {
            if (!confirm('Are you sure you want to delete this bus?')) return;

            try {
                await db.collection('buses').doc(busId).delete();
                alert('Bus deleted successfully!');
                loadAdminBuses();
            } catch (error) {
                console.error('Error deleting bus:', error);
                alert('Error deleting bus: ' + error.message);
            }
        }

        // Load admin drivers
        async function loadAdminDrivers() {
            try {
                const driversSnapshot = await db.collection('drivers').get();

                let tableHTML = `
                    <table class="table" id="drivers-table">
                        <thead>
                            <tr>
                                <th>Driver ID</th>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Personal Phone</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                driversSnapshot.forEach(doc => {
                    const driver = doc.data();
                    tableHTML += `
                        <tr>
                            <td>${driver.driverId || 'N/A'}</td>
                            <td>${driver.name}</td>
                            <td>${driver.phone}</td>
                            <td>${driver.personalPhone}</td>
                            <td>${driver.email}</td>
                            <td><span class="bus-status status-ontime">Active</span></td>
                            <td>
                                <button class="btn" onclick="editDriver('${doc.id}')">Edit</button>
                                <button class="btn btn-danger" onclick="deleteDriver('${doc.id}')">Delete</button>
                            </td>
                        </tr>
                    `;
                });

                tableHTML += '</tbody></table>';
                document.getElementById('admin-driver-table').innerHTML = tableHTML;
            } catch (error) {
                console.error('Error loading drivers:', error);
                document.getElementById('admin-driver-table').innerHTML = '<p>Error loading driver information</p>';
            }
        }

        // Search drivers function
        function searchDrivers() {
            const input = document.getElementById('driver-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('drivers-table');
            const tr = table.getElementsByTagName('tr');

            // Loop through all table rows, and hide those that don't match the search query
            for (let i = 1; i < tr.length; i++) {
                let td = tr[i].getElementsByTagName('td');
                let found = false;

                for (let j = 0; j < td.length; j++) {
                    if (td[j]) {
                        const txtValue = td[j].textContent || td[j].innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            found = true;
                            break;
                        }
                    }
                }

                if (found) {
                    tr[i].style.display = '';
                } else {
                    tr[i].style.display = 'none';
                }
            }
        }

        // Delete driver function
        async function deleteDriver(driverId) {
            if (!confirm('Are you sure you want to delete this driver?')) return;

            try {
                // First check if driver is assigned to any bus
                const busWithDriver = await db.collection('buses').where('driverId', '==', driverId).get();

                if (!busWithDriver.empty) {
                    alert('Cannot delete driver. This driver is currently assigned to a bus. Please reassign the bus first.');
                    return;
                }

                // Get driver data to delete from auth
                const driverDoc = await db.collection('drivers').doc(driverId).get();
                if (driverDoc.exists) {
                    const driverData = driverDoc.data();

                    // Delete from drivers collection
                    await db.collection('drivers').doc(driverId).delete();

                    // Delete from users collection
                    await db.collection('users').doc(driverId).delete();

                    // In a real app, you would also delete the auth user
                    // await auth.deleteUser(driverId);

                    alert('Driver deleted successfully!');
                    loadAdminDrivers();
                }
            } catch (error) {
                console.error('Error deleting driver:', error);
                alert('Error deleting driver: ' + error.message);
            }
        }

        // Show add driver form
        function showAddDriverForm() {
            document.getElementById('driver-form-title').textContent = 'Add New Driver';
            document.getElementById('driver-form').reset();
            document.getElementById('driver-id').value = '';
            document.getElementById('driver-password').required = true;
            document.getElementById('driver-form-container').classList.remove('hidden');
        }

        // Edit driver
        async function editDriver(driverId) {
            try {
                const driverDoc = await db.collection('drivers').doc(driverId).get();
                if (driverDoc.exists) {
                    const driver = driverDoc.data();

                    document.getElementById('driver-form-title').textContent = 'Edit Driver';
                    document.getElementById('driver-id').value = driverId;
                    document.getElementById('driver-name').value = driver.name || '';
                    document.getElementById('driver-phone').value = driver.phone || '';
                    document.getElementById('driver-personal-phone').value = driver.personalPhone || '';
                    document.getElementById('driver-email').value = driver.email || '';
                    document.getElementById('driver-password').required = false;

                    document.getElementById('driver-form-container').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading driver for edit:', error);
                alert('Error loading driver information');
            }
        }

        // Hide driver form
        function hideDriverForm() {
            document.getElementById('driver-form-container').classList.add('hidden');
        }

        // Save driver (add or edit) - FIXED VERSION
        document.getElementById('driver-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const driverId = document.getElementById('driver-id').value;
            const driverData = {
                name: document.getElementById('driver-name').value,
                phone: document.getElementById('driver-phone').value,
                personalPhone: document.getElementById('driver-personal-phone').value,
                email: document.getElementById('driver-email').value,
                type: 'driver'
            };

            const password = document.getElementById('driver-password').value;

            try {
                if (driverId) {
                    // Update existing driver
                    await db.collection('drivers').doc(driverId).update(driverData);

                    // ALSO update in users collection - FIX ADDED
                    await db.collection('users').doc(driverId).update(driverData);

                    // Update password if provided
                    if (password) {
                        console.log('Password update would happen here in a real app');
                    }

                    alert('Driver updated successfully!');
                } else {
                    // Add new driver
                    if (!password) {
                        alert('Password is required for new drivers');
                        return;
                    }

                    // Create auth user FIRST
                    const userCredential = await auth.createUserWithEmailAndPassword(driverData.email, password);
                    const user = userCredential.user;

                    // Add driver data to BOTH collections
                    driverData.driverId = 'DRV' + Date.now().toString().slice(-5);
                    driverData.type = 'driver';
                    driverData.createdAt = firebase.firestore.FieldValue.serverTimestamp();

                    // Save to drivers collection
                    await db.collection('drivers').doc(user.uid).set(driverData);

                    // ALSO save to users collection - THIS WAS MISSING - NOW FIXED
                    await db.collection('users').doc(user.uid).set(driverData);

                    alert('Driver added successfully!');
                }

                hideDriverForm();
                loadAdminDrivers();
            } catch (error) {
                console.error('Error saving driver:', error);

                // More specific error handling
                if (error.code === 'auth/email-already-in-use') {
                    alert('This email is already registered. Please use a different email.');
                } else if (error.code === 'auth/weak-password') {
                    alert('Password is too weak. Please use a stronger password.');
                } else {
                    alert('Error saving driver: ' + error.message);
                }
            }
        });

        // Toggle driver status
        async function toggleDriverStatus(driverId) {
            // This would toggle the driver's active status in a real app
            alert('Driver status would be toggled here in a real implementation');
        }

        // Load admin students
        async function loadAdminStudents() {
            try {
                const studentsSnapshot = await db.collection('users').where('type', '==', 'student').get();
                const busesSnapshot = await db.collection('buses').get();

                // Populate route dropdown
                const routeSelect = document.getElementById('student-form-route');
                routeSelect.innerHTML = '<option value="">-- Select Route --</option>';

                busesSnapshot.forEach(doc => {
                    const bus = doc.data();
                    const option = document.createElement('option');
                    option.value = bus.routeNo;
                    option.textContent = `Route ${bus.routeNo} - ${bus.routeName}`;
                    routeSelect.appendChild(option);
                });

                let tableHTML = `
                    <table class="table" id="students-table">
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Department</th>
                                <th>Batch</th>
                                <th>Route</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    tableHTML += `
                        <tr>
                            <td>${student.studentId || 'N/A'}</td>
                            <td>${student.name || 'N/A'}</td>
                            <td>${student.department || 'N/A'}</td>
                            <td>${student.batch || 'N/A'}</td>
                            <td>${student.route || 'N/A'}</td>
                            <td><span class="bus-status status-ontime">Active</span></td>
                            <td>
                                <button class="btn" onclick="editStudent('${doc.id}')">Edit</button>
                                <button class="btn btn-danger" onclick="deleteStudent('${doc.id}')">Delete</button>
                            </td>
                        </tr>
                    `;
                });

                tableHTML += '</tbody></table>';
                document.getElementById('admin-student-table').innerHTML = tableHTML;
            } catch (error) {
                console.error('Error loading students:', error);
                document.getElementById('admin-student-table').innerHTML = '<p>Error loading student information</p>';
            }
        }

        // Search students function
        function searchStudents() {
            const input = document.getElementById('student-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('students-table');
            const tr = table.getElementsByTagName('tr');

            // Loop through all table rows, and hide those that don't match the search query
            for (let i = 1; i < tr.length; i++) {
                let td = tr[i].getElementsByTagName('td');
                let found = false;

                for (let j = 0; j < td.length; j++) {
                    if (td[j]) {
                        const txtValue = td[j].textContent || td[j].innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            found = true;
                            break;
                        }
                    }
                }

                if (found) {
                    tr[i].style.display = '';
                } else {
                    tr[i].style.display = 'none';
                }
            }
        }

        // Delete student function
        async function deleteStudent(studentId) {
            if (!confirm('Are you sure you want to delete this student?')) return;

            try {
                // Get student data
                const studentDoc = await db.collection('users').doc(studentId).get();
                if (studentDoc.exists) {
                    const studentData = studentDoc.data();

                    // Delete from users collection
                    await db.collection('users').doc(studentId).delete();

                    // Delete student's bookings
                    const bookings = await db.collection('bookings')
                        .where('studentId', '==', studentData.studentId)
                        .get();

                    const deletePromises = [];
                    bookings.forEach(doc => {
                        deletePromises.push(doc.ref.delete());
                    });

                    await Promise.all(deletePromises);

                    // In a real app, you would also delete the auth user
                    // await auth.deleteUser(studentId);

                    alert('Student deleted successfully!');
                    loadAdminStudents();
                }
            } catch (error) {
                console.error('Error deleting student:', error);
                alert('Error deleting student: ' + error.message);
            }
        }

        // Show add student form
        function showAddStudentForm() {
            document.getElementById('student-form-title').textContent = 'Add New Student';
            document.getElementById('student-form').reset();
            document.getElementById('student-form-id').value = '';
            document.getElementById('student-form-password').required = true;
            document.getElementById('student-form-container').classList.remove('hidden');
        }

        // Edit student
        async function editStudent(studentId) {
            try {
                const studentDoc = await db.collection('users').doc(studentId).get();
                if (studentDoc.exists) {
                    const student = studentDoc.data();

                    document.getElementById('student-form-title').textContent = 'Edit Student';
                    document.getElementById('student-form-id').value = studentId;
                    document.getElementById('student-form-name').value = student.name || '';
                    document.getElementById('student-form-id-input').value = student.studentId || '';
                    document.getElementById('student-form-email').value = student.email || '';
                    document.getElementById('student-form-department').value = student.department || '';
                    document.getElementById('student-form-batch').value = student.batch || '';
                    document.getElementById('student-form-phone').value = student.phone || '';
                    document.getElementById('student-form-route').value = student.route || '';
                    document.getElementById('student-form-password').required = false;

                    document.getElementById('student-form-container').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading student for edit:', error);
                alert('Error loading student information');
            }
        }

        // Hide student form
        function hideStudentForm() {
            document.getElementById('student-form-container').classList.add('hidden');
        }

        // Save student (add or edit)
        document.getElementById('student-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const studentId = document.getElementById('student-form-id').value;
            const studentData = {
                name: document.getElementById('student-form-name').value,
                studentId: document.getElementById('student-form-id-input').value,
                email: document.getElementById('student-form-email').value,
                department: document.getElementById('student-form-department').value,
                batch: document.getElementById('student-form-batch').value,
                phone: document.getElementById('student-form-phone').value,
                route: document.getElementById('student-form-route').value,
                type: 'student'
            };

            const password = document.getElementById('student-form-password').value;

            try {
                if (studentId) {
                    // Update existing student
                    await db.collection('users').doc(studentId).update(studentData);

                    // Update password if provided
                    if (password) {
                        // In a real app, you would update the auth user password here
                        console.log('Password update would happen here in a real app');
                    }

                    alert('Student updated successfully!');
                } else {
                    // Add new student
                    if (!password) {
                        alert('Password is required for new students');
                        return;
                    }

                    // Create auth user
                    const userCredential = await auth.createUserWithEmailAndPassword(studentData.email, password);
                    const user = userCredential.user;

                    // Add student data to Firestore
                    await db.collection('users').doc(user.uid).set(studentData);

                    alert('Student added successfully!');
                }

                hideStudentForm();
                loadAdminStudents();
            } catch (error) {
                console.error('Error saving student:', error);
                alert('Error saving student: ' + error.message);
            }
        });

        // Toggle student status
        async function toggleStudentStatus(studentId) {
            // This would toggle the student's active status in a real app
            alert('Student status would be toggled here in a real implementation');
        }

        // Load admin tracking
        async function loadAdminTracking() {
            try {
                const busesSnapshot = await db.collection('buses').get();

                // Initialize map (simulated)
                document.getElementById('admin-map').innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background-color: #e9ecef; color: #6c757d;">
                        <div style="text-align: center;">
                            <div style="font-size: 3rem;">üó∫Ô∏è</div>
                            <p>Live Tracking of All Buses</p>
                            <p>Real-time location of ${busesSnapshot.size} active buses</p>
                        </div>
                    </div>
                `;

                let tableHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Route</th>
                                <th>Bus Number</th>
                                <th>Driver</th>
                                <th>Last Location</th>
                                <th>Status</th>
                                <th>Speed</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                for (const doc of busesSnapshot.docs) {
                    const bus = doc.data();

                    // Get driver info
                    let driverName = 'N/A';
                    if (bus.driverId) {
                        const driverDoc = await db.collection('drivers').doc(bus.driverId).get();
                        if (driverDoc.exists) {
                            driverName = driverDoc.data().name;
                        }
                    }

                    tableHTML += `
                        <tr>
                            <td>${bus.routeNo} - ${bus.routeName}</td>
                            <td>${bus.busNumber}</td>
                            <td>${driverName}</td>
                            <td>${bus.nextStop || 'N/A'}</td>
                            <td><span class="bus-status ${bus.status === 'Delayed' ? 'status-delayed' : 'status-ontime'}">${bus.status || 'N/A'}</span></td>
                            <td>${bus.status === 'On the way' ? '35 km/h' : '0 km/h'}</td>
                        </tr>
                    `;
                }

                tableHTML += '</tbody></table>';
                document.getElementById('admin-bus-locations').innerHTML = tableHTML;
            } catch (error) {
                console.error('Error loading tracking:', error);
                document.getElementById('admin-bus-locations').innerHTML = '<p>Error loading tracking information</p>';
            }
        }

        // Load admin notifications
        async function loadAdminNotifications() {
            try {
                const notificationsSnapshot = await db.collection('notifications')
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();

                // Load routes for dropdown
                const routesSnapshot = await db.collection('buses').get();
                const routeSelect = document.getElementById('admin-notification-route');
                routeSelect.innerHTML = '<option value="">-- Select Route --</option>';

                routesSnapshot.forEach(doc => {
                    const bus = doc.data();
                    const option = document.createElement('option');
                    option.value = bus.routeNo;
                    option.textContent = `Route ${bus.routeNo} - ${bus.routeName}`;
                    routeSelect.appendChild(option);
                });

                let notificationsHTML = '';

                if (notificationsSnapshot.empty) {
                    notificationsHTML = '<p>No notifications yet</p>';
                } else {
                    notificationsSnapshot.forEach(doc => {
                        const notification = doc.data();
                        const timestamp = notification.timestamp ? new Date(notification.timestamp.toDate()).toLocaleString() : 'Unknown time';
                        notificationsHTML += `
                            <div class="notification">
                                <strong>${notification.title}</strong> - ${notification.message} 
                                (Sent: ${timestamp} | 
                                To: ${notification.audience ? notification.audience.join(', ') : 'N/A'})
                            </div>
                        `;
                    });
                }

                document.getElementById('admin-notification-history').innerHTML = notificationsHTML;
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        // Send admin notification
        async function sendAdminNotification() {
            const type = document.getElementById('admin-notification-type').value;
            const title = document.getElementById('admin-notification-title').value;
            const message = document.getElementById('admin-notification-message').value;
            const audience = document.getElementById('admin-notification-audience').value;
            const route = document.getElementById('admin-notification-route').value;

            if (!title || !message) {
                alert('Please fill in all fields');
                return;
            }

            let targetAudience = [];
            if (audience === 'all') {
                targetAudience = ['all'];
            } else if (audience === 'students') {
                targetAudience = ['students'];
            } else if (audience === 'drivers') {
                targetAudience = ['drivers'];
            } else if (audience === 'specific-route' && route) {
                targetAudience = [route];
            } else {
                alert('Please select a route for specific route notifications');
                return;
            }

            try {
                await db.collection('notifications').add({
                    title: title,
                    message: message,
                    type: type,
                    audience: targetAudience,
                    sender: 'Admin',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Notification sent successfully!');

                // Clear form
                document.getElementById('admin-notification-title').value = '';
                document.getElementById('admin-notification-message').value = '';

                // Reload notifications
                loadAdminNotifications();
            } catch (error) {
                console.error('Error sending notification:', error);
                alert('Error sending notification: ' + error.message);
            }
        }

        // Show route selection when specific route is chosen for notifications
        document.getElementById('admin-notification-audience').addEventListener('change', function () {
            const routeSelectContainer = document.getElementById('route-select-container');
            if (this.value === 'specific-route') {
                routeSelectContainer.style.display = 'block';
            } else {
                routeSelectContainer.style.display = 'none';
            }
        });

        // Initialize the application
        showMainPortal();

        // Auth state listener - FIXED VERSION
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    // User is signed in
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        currentUser = user;
                        currentUserData = userDoc.data();

                        // Redirect to appropriate portal
                        mainPortal.classList.add('hidden');
                        loginForms.classList.add('hidden');

                        if (currentUserData.type === 'student') {
                            studentPortal.classList.remove('hidden');
                            loadStudentData();
                            showStudentSection('dashboard');
                        } else if (currentUserData.type === 'driver') {
                            driverPortal.classList.remove('hidden');
                            loadDriverData();
                            showDriverSection('dashboard');
                        } else if (currentUserData.type === 'admin') {
                            adminPortal.classList.remove('hidden');
                            loadAdminData();
                            showAdminSection('dashboard');
                        }
                    } else {
                        console.log('User document not found in users collection, checking drivers collection...');

                        // Check if user exists in drivers collection
                        const driverDoc = await db.collection('drivers').doc(user.uid).get();
                        if (driverDoc.exists) {
                            // User is a driver but not in users collection - fix this
                            const driverData = driverDoc.data();
                            await db.collection('users').doc(user.uid).set(driverData);

                            // Reload page or redirect
                            location.reload();
                        } else {
                            // User document not found in any collection, sign out
                            await auth.signOut();
                            alert('User data not found. Please contact administrator.');
                        }
                    }
                } catch (error) {
                    console.error('Error in auth state change:', error);
                    // Don't auto-logout on error, just show main portal
                    showMainPortal();
                }
            } else {
                // User is signed out
                currentUser = null;
                currentUserData = null;
                showMainPortal();
            }
        });

        // Initialize sample data on page load
        initializeSampleData();

        // Load report form data
        async function loadReportForm() {
            try {
                // Set default date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('report-date').value = today;

                // Load routes
                const routesSnapshot = await db.collection('buses').get();
                const routeSelect = document.getElementById('report-route');
                routeSelect.innerHTML = '<option value="">-- Select Route --</option>';

                routesSnapshot.forEach(doc => {
                    const bus = doc.data();
                    const option = document.createElement('option');
                    option.value = bus.routeNo;
                    option.textContent = `Route ${bus.routeNo} - ${bus.routeName}`;
                    routeSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading report form:', error);
            }
        }

        // Generate passenger report
        async function generatePassengerReport() {
            const date = document.getElementById('report-date').value;
            const routeNo = document.getElementById('report-route').value;

            if (!date || !routeNo) {
                alert('Please select both date and route');
                return;
            }

            try {
                // Show loading state
                const generateBtn = document.querySelector('#admin-reports .btn-success');
                const originalText = generateBtn.textContent;
                generateBtn.textContent = 'Generating Report...';
                generateBtn.disabled = true;

                // Get bus data
                const busDoc = await db.collection('buses').where('routeNo', '==', routeNo).get();
                if (busDoc.empty) {
                    alert('No bus found for selected route');
                    return;
                }

                const busData = busDoc.docs[0].data();
                const busId = busDoc.docs[0].id;

                // Get driver info
                let driverName = 'N/A';
                if (busData.driverId) {
                    const driverDoc = await db.collection('drivers').doc(busData.driverId).get();
                    if (driverDoc.exists) {
                        driverName = driverDoc.data().name;
                    }
                }

                // Get bookings for both directions
                const toCampusBookings = await db.collection('bookings')
                    .where('routeNo', '==', routeNo)
                    .where('date', '==', date)
                    .where('direction', '==', 'to-campus')
                    .get();

                const fromCampusBookings = await db.collection('bookings')
                    .where('routeNo', '==', routeNo)
                    .where('date', '==', date)
                    .where('direction', '==', 'from-campus')
                    .get();

                // Generate PDF
                await generatePDFReport(
                    busData,
                    driverName,
                    toCampusBookings,
                    fromCampusBookings,
                    date,
                    routeNo
                );

                // Update recent reports
                await updateRecentReports(date, routeNo);

            } catch (error) {
                console.error('Error generating report:', error);
                alert('Error generating report: ' + error.message);
            } finally {
                // Reset button state
                const generateBtn = document.querySelector('#admin-reports .btn-success');
                generateBtn.textContent = 'Generate PDF Report';
                generateBtn.disabled = false;
            }
        }

        // Generate PDF report
        async function generatePDFReport(busData, driverName, toCampusBookings, fromCampusBookings, date, routeNo) {
            // Create new PDF document
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let totalPagesAdded = 0;

            // Helper function to add first page of a direction with full header
            function addFirstPageOfDirection(direction, bookings, departureTime) {
                // Always start on a new page for first page of each direction
                if (totalPagesAdded > 0) {
                    doc.addPage();
                    totalPagesAdded++;
                } else {
                    totalPagesAdded = 1;
                }

                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();

                // Top header for first page
                const currentDate = new Date();
                const generatedDateTime = currentDate.toLocaleString();

                // Left: Generated on date & time
                doc.setFontSize(8);
                doc.setTextColor(100);
                doc.text(`Generated on: ${generatedDateTime}`, 14, 10);

                // Right: Page number and direction
                const pageNumber = totalPagesAdded;
                doc.text(`Page No: ${pageNumber} - ${direction}`, pageWidth - 14, 10, { align: 'right' });

                // Main header content
                // Center: Sonargaon University Bus Management
                doc.setFontSize(16);
                doc.setTextColor(40);
                doc.setFont(undefined, 'bold');
                doc.text('Sonargaon University Bus Management', pageWidth / 2, 30, { align: 'center' });

                // Center: Date, time & Day
                const reportDate = new Date(date);
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayName = dayNames[reportDate.getDay()];
                const formattedDate = reportDate.toLocaleDateString();

                doc.setFontSize(12);
                doc.setTextColor(80);
                doc.text(`${formattedDate} - ${dayName}`, pageWidth / 2, 40, { align: 'center' });

                // Direction title (without page number)
                doc.setFontSize(14);
                doc.setTextColor(40);
                doc.setFont(undefined, 'bold');
                doc.text(`${direction}`, pageWidth / 2, 55, { align: 'center' });

                // Bus and route details
                doc.setFontSize(10);
                doc.setTextColor(60);

                // Left column
                doc.text(`Route: ${busData.routeNo} - ${busData.routeName}`, 14, 70);
                doc.text(`Bus: ${busData.busNumber}`, 14, 77);
                doc.text(`Capacity: ${busData.capacity || 40}`, 14, 84);

                // Right column
                doc.text(`Driver: ${driverName}`, pageWidth - 60, 70);
                doc.text(`Departure: ${departureTime}`, pageWidth - 60, 77);

                // Total Passengers
                const totalPassengers = bookings.size;
                doc.text(`Total Passengers: ${totalPassengers}`, pageWidth - 60, 84);

                return { pageWidth, pageHeight, tableTop: 95 };
            }

            // Helper function to add subsequent pages of a direction with minimal header
            function addSubsequentPageOfDirection(direction) {
                doc.addPage();
                totalPagesAdded++;

                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();

                // Top header for subsequent pages
                const currentDate = new Date();
                const generatedDateTime = currentDate.toLocaleString();

                // Left: Generated on date & time
                doc.setFontSize(8);
                doc.setTextColor(100);
                doc.text(`Generated on: ${generatedDateTime}`, 14, 10);

                // Center: Route info
                doc.text(`Route: ${busData.routeNo} - ${busData.routeName}`, pageWidth / 2, 10, { align: 'center' });

                // Right: Page number and direction
                const pageNumber = totalPagesAdded;
                doc.text(`Page No: ${pageNumber} - ${direction}`, pageWidth - 14, 10, { align: 'right' });

                // Only direction title (without page number)
                doc.setFontSize(14);
                doc.setTextColor(40);
                doc.setFont(undefined, 'bold');
                doc.text(`${direction}`, pageWidth / 2, 25, { align: 'center' });

                return { pageWidth, pageHeight, tableTop: 35 };
            }

            // Helper function to add table header
            function addTableHeader(tableTop) {
                doc.setFillColor(41, 128, 185);
                doc.setTextColor(255);
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.rect(14, tableTop, 172, 8, 'F');
                doc.text('Seat No', 20, tableTop + 6);
                doc.text('Student ID', 45, tableTop + 6);
                doc.text('Stop Name', 80, tableTop + 6);
                doc.text('Stop Time', 125, tableTop + 6);
                doc.text('Student Name', 150, tableTop + 6);

                // Reset for data rows
                doc.setTextColor(0);
                doc.setFont(undefined, 'normal');
            }

            // Helper function to add footer
            function addFooter(pageWidth, pageHeight) {
                doc.setFontSize(9);
                doc.setTextColor(100);
                doc.text('This document is automatically generated from the system. No signature is required',
                    pageWidth / 2, pageHeight - 20, { align: 'center' });
                doc.text('Designed & Developed by Tasrik Hossain | Fahmida Mim',
                    pageWidth / 2, pageHeight - 10, { align: 'center' });
            }

            // Helper function to process bookings for a direction with multiple pages support
            function processDirectionBookings(direction, bookings, departureTime) {
                let isFirstPage = true;
                let pageData;

                if (bookings.empty) {
                    // Even if no bookings, create one page for this direction with full header
                    pageData = addFirstPageOfDirection(direction, bookings, departureTime);
                    addTableHeader(pageData.tableTop);
                    doc.text('No bookings for this direction', 20, pageData.tableTop + 15);
                    addFooter(pageData.pageWidth, pageData.pageHeight);
                    return;
                }

                // Sort bookings by seat number
                const sortedBookings = [];
                bookings.forEach(doc => {
                    sortedBookings.push(doc.data());
                });

                sortedBookings.sort((a, b) => {
                    return parseInt(a.seatNumber) - parseInt(b.seatNumber);
                });

                let currentIndex = 0;
                const pageHeight = doc.internal.pageSize.getHeight();
                const lineHeight = 7;
                const bottomMargin = 40;

                while (currentIndex < sortedBookings.length) {
                    if (isFirstPage) {
                        // For first page of any direction, use full header
                        pageData = addFirstPageOfDirection(direction, bookings, departureTime);
                    } else {
                        pageData = addSubsequentPageOfDirection(direction);
                    }

                    // Add table header
                    addTableHeader(pageData.tableTop);

                    let yPos = pageData.tableTop + 15;

                    // Add bookings for current page
                    while (currentIndex < sortedBookings.length && yPos <= pageHeight - bottomMargin) {
                        const booking = sortedBookings[currentIndex];

                        doc.text(booking.seatLabel || booking.seatNumber, 20, yPos);
                        doc.text(booking.studentId || 'N/A', 45, yPos);
                        doc.text(booking.stop || 'N/A', 80, yPos);
                        doc.text(booking.stopTime || 'N/A', 125, yPos);
                        doc.text(booking.studentName || 'N/A', 150, yPos);

                        yPos += lineHeight;
                        currentIndex++;
                    }

                    // Add footer to every page
                    addFooter(pageData.pageWidth, pageData.pageHeight);
                    isFirstPage = false;
                }
            }

            // Process To SU Campus direction - this will always start on page 1
            processDirectionBookings('To Green Road, SU Campus', toCampusBookings, busData.departureTime || 'N/A');

            // Process From SU Campus direction - this will always start on a new page
            processDirectionBookings('From Green Road, SU Campus', fromCampusBookings, busData.departureTimeFromCampus || 'N/A');

            // Save PDF
            const fileName = `SU_Bus_Report_${routeNo}_${date.replace(/-/g, '')}.pdf`;
            doc.save(fileName);
        }

        // Update recent reports list (unchanged)
        async function updateRecentReports(date, routeNo) {
            try {
                // Get recent reports element
                const recentReportsList = document.getElementById('recent-reports-list');

                // Create report entry
                const reportEntry = document.createElement('div');
                reportEntry.className = 'report-entry';
                reportEntry.style.padding = '10px';
                reportEntry.style.borderBottom = '1px solid #eee';
                reportEntry.style.display = 'flex';
                reportEntry.style.justifyContent = 'space-between';
                reportEntry.style.alignItems = 'center';

                const reportDate = new Date(date);
                const formattedDate = reportDate.toLocaleDateString();

                reportEntry.innerHTML = `
            <div>
                <strong>Route ${routeNo}</strong>
                <div style="font-size: 0.9rem; color: #666;">${formattedDate}</div>
            </div>
            <div style="font-size: 0.9rem; color: #666;">
                Generated: ${new Date().toLocaleTimeString()}
            </div>
        `;

                // Add to top of list
                if (recentReportsList.firstChild && recentReportsList.firstChild.tagName !== 'DIV') {
                    recentReportsList.innerHTML = '';
                }
                recentReportsList.prepend(reportEntry);

            } catch (error) {
                console.error('Error updating recent reports:', error);
            }
        }
    </script>
</body>

</html>